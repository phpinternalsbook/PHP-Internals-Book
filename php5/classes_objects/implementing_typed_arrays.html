<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Implementing typed arrays &#8212; PHP Internals Book</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/haiku.css?v=fce32b03" />
    <link rel="stylesheet" type="text/css" href="../../_static/style.css?v=38da9290" />
    <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Object handlers" href="object_handlers.html" />
    <link rel="prev" title="Custom object storage" href="custom_object_storage.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../index.html">
          <span>PHP Internals Book</span></a></h1>
        <h2 class="heading"><span>Implementing typed arrays</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="Top">
      
        <p>
        «&#160;&#160;<a href="custom_object_storage.html">Custom object storage</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="object_handlers.html">Object handlers</a>&#160;&#160;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <section id="implementing-typed-arrays">
<h1>Implementing typed arrays<a class="headerlink" href="#implementing-typed-arrays" title="Link to this heading">¶</a></h1>
<p>The previous two sections have been talking about the class system rather abstractly. In this section on the other hand
I’d like to guide you through the implementation of a “real” class: A typed array. I use this as an example for two
reasons: Firstly, typed arrays are something where it really makes sense to implement them internally. They are rather
hard to implement in userland PHP and an internal implementation can use both less memory and be a lot faster. Secondly,
typed arrays are good to show off some of PHP’s object and class handlers. For example they need offset access, element
counting, iteration, serialization and debug information.</p>
<section id="array-buffers-and-views">
<h2>Array buffers and views<a class="headerlink" href="#array-buffers-and-views" title="Link to this heading">¶</a></h2>
<p>What we’ll implement in this section is a reduced version of JavaScript’s ArrayBuffer system. An <code class="docutils literal notranslate"><span class="pre">ArrayBuffer</span></code> is just
a chunk of memory with a fixed size. The <code class="docutils literal notranslate"><span class="pre">ArrayBuffer</span></code> by itself cannot be read or written to, it is just an object
representing the memory.</p>
<p>In order to read from or write to the buffer you have to create a view on it. E.g. to interpret the buffer as an array
of signed 32-bit integers you create a <code class="docutils literal notranslate"><span class="pre">Int32Array</span></code> view. To view it as an array of unsigned 8-bit numbers instead you
can use a <code class="docutils literal notranslate"><span class="pre">UInt8Array</span></code>. It is possible to have several views on the same data, so data can be interpreted both as an
int32 and a uint8.</p>
<p>A small usage example:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// allocate a buffer containing 256 bytes</span>
<span class="nv">$buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">256</span><span class="p">);</span>

<span class="c1">// create an int32 view on the buffer with 256 / 8 = 32 elements</span>
<span class="nv">$int32</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Int32Array</span><span class="p">(</span><span class="nv">$buffer</span><span class="p">);</span>

<span class="c1">// create a uint8 view on the same buffer with 256 / 1 = 256 elements</span>
<span class="nv">$uint8</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UInt8Array</span><span class="p">(</span><span class="nv">$buffer</span><span class="p">);</span>

<span class="c1">// fill the uint8 view with values from 0 to 255</span>
<span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="o">++</span><span class="nv">$i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$uint8</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$i</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// now read the filled buffer interpreting it as signed 32-bit integers</span>
<span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="o">++</span><span class="nv">$i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$int32</span><span class="p">[</span><span class="nv">$i</span><span class="p">],</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This kind of buffer + view system is handy for many purposes, so it’ll be the system that will be implemented here. To
not make this overly long we won’t implement the whole JS API, only the most important parts of it. Furthermore I won’t
spend much time considering details of the implementations like overflow behavior and endianness. Those are very
important considerations for a “real” implementation, but for our purposes it’s not really relevant, so I’ll just stick
with the behaviors that you get “by default” (i.e. with least code).</p>
</section>
<section id="the-arraybuffer">
<h2>The <code class="docutils literal notranslate"><span class="pre">ArrayBuffer</span></code><a class="headerlink" href="#the-arraybuffer" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">ArrayBuffer</span></code> is a very simple object, that only needs to allocate and store a buffer and its length. Thus the
internal structure could look like this:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">_buffer_object</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">zend_object</span><span class="w"> </span><span class="n">std</span><span class="p">;</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">length</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">buffer_object</span><span class="p">;</span>

<span class="cm">/* Use the chance to declare CE and handlers too */</span>
<span class="n">zend_class_entry</span><span class="w"> </span><span class="o">*</span><span class="n">array_buffer_ce</span><span class="p">;</span>
<span class="n">zend_object_handlers</span><span class="w"> </span><span class="n">array_buffer_handlers</span><span class="p">;</span>
</pre></div>
</div>
<p>The create and free handlers are similarly simple and look nearly the same as the ones in the previous section:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">array_buffer_free_object_storage</span><span class="p">(</span><span class="n">buffer_object</span><span class="w"> </span><span class="o">*</span><span class="n">intern</span><span class="w"> </span><span class="n">TSRMLS_DC</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">zend_object_std_dtor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">std</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">efree</span><span class="p">(</span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">efree</span><span class="p">(</span><span class="n">intern</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">zend_object_value</span><span class="w"> </span><span class="nf">array_buffer_create_object</span><span class="p">(</span><span class="n">zend_class_entry</span><span class="w"> </span><span class="o">*</span><span class="n">class_type</span><span class="w"> </span><span class="n">TSRMLS_DC</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">zend_object_value</span><span class="w"> </span><span class="n">retval</span><span class="p">;</span>

<span class="w">    </span><span class="n">buffer_object</span><span class="w"> </span><span class="o">*</span><span class="n">intern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">emalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer_object</span><span class="p">));</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">intern</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer_object</span><span class="p">));</span>

<span class="w">    </span><span class="n">zend_object_std_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">,</span><span class="w"> </span><span class="n">class_type</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">);</span>
<span class="w">    </span><span class="n">object_properties_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">,</span><span class="w"> </span><span class="n">class_type</span><span class="p">);</span>

<span class="w">    </span><span class="n">retval</span><span class="p">.</span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zend_objects_store_put</span><span class="p">(</span><span class="n">intern</span><span class="p">,</span>
<span class="w">        </span><span class="p">(</span><span class="n">zend_objects_store_dtor_t</span><span class="p">)</span><span class="w"> </span><span class="n">zend_objects_destroy_object</span><span class="p">,</span>
<span class="w">        </span><span class="p">(</span><span class="n">zend_objects_free_object_storage_t</span><span class="p">)</span><span class="w"> </span><span class="n">array_buffer_free_object_storage</span><span class="p">,</span>
<span class="w">        </span><span class="nb">NULL</span><span class="w"> </span><span class="n">TSRMLS_CC</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="n">retval</span><span class="p">.</span><span class="n">handlers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">array_buffer_handlers</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">create_object</span></code> handler does not yet allocate the buffer, this is done in the constructor (because it depends on
the buffer length, which is a ctor parameter):</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PHP_METHOD</span><span class="p">(</span><span class="n">ArrayBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">__construct</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">buffer_object</span><span class="w"> </span><span class="o">*</span><span class="n">intern</span><span class="p">;</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">length</span><span class="p">;</span>
<span class="w">    </span><span class="n">zend_error_handling</span><span class="w"> </span><span class="n">error_handling</span><span class="p">;</span>

<span class="w">    </span><span class="n">zend_replace_error_handling</span><span class="p">(</span><span class="n">EH_THROW</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error_handling</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">zend_parse_parameters</span><span class="p">(</span><span class="n">ZEND_NUM_ARGS</span><span class="p">()</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;l&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">length</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FAILURE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">zend_restore_error_handling</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error_handling</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">zend_restore_error_handling</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error_handling</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">length</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">zend_throw_exception</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Buffer length must be positive&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">intern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zend_object_store_get_object</span><span class="p">(</span><span class="n">getThis</span><span class="p">()</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">);</span>

<span class="w">    </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">emalloc</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
<span class="w">    </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length</span><span class="p">;</span>

<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As we are now writing object-oriented code we no longer throw errors, but rather exceptions. This is done using
<code class="docutils literal notranslate"><span class="pre">zend_throw_exception</span></code>, which takes the exception class entry, the exception message and the error code. If you pass
<code class="docutils literal notranslate"><span class="pre">NULL</span></code> as the exception CE then you’ll get a default exception, i.e. <code class="docutils literal notranslate"><span class="pre">Exception</span></code>.</p>
<p>Especially for the <code class="docutils literal notranslate"><span class="pre">__construct</span></code> method is it important that you throw an exception in case of an error to avoid
ending up with a partially constructed object. That’s also the reason why the above code replaces the error handling
mode during parameter parsing. Normally <code class="docutils literal notranslate"><span class="pre">zend_parse_parameters</span></code> would only throw a warning on invalid parameters,
which wouldn’t be enough in this case. By setting the error mode to <code class="docutils literal notranslate"><span class="pre">EH_THROW</span></code> the warning is automatically converted
into an exception.</p>
<p>The error handling mode can be changed using <code class="docutils literal notranslate"><span class="pre">zend_replace_error_handling</span></code>. It takes one of <code class="docutils literal notranslate"><span class="pre">EH_NORMAL</span></code> (default
error reporting), <code class="docutils literal notranslate"><span class="pre">EH_SUPPRESS</span></code> (silence all errors) or <code class="docutils literal notranslate"><span class="pre">EH_THROW</span></code> (throw errors as exceptions) as the first
argument. The second argument can be used to specify the exception CE for the <code class="docutils literal notranslate"><span class="pre">EH_THROW</span></code> mode. If <code class="docutils literal notranslate"><span class="pre">NULL</span></code> is passed
the default <code class="docutils literal notranslate"><span class="pre">Exception</span></code> class is used. As the last parameter a pointer to a <code class="docutils literal notranslate"><span class="pre">zend_error_handling</span></code> structure is
passed, into which the previous error mode is backed up. This structure is later passed to
<code class="docutils literal notranslate"><span class="pre">zend_restore_error_handling</span></code> to get the old mode back.</p>
<p>Apart from the create handler you also have to handle cloning. For the <code class="docutils literal notranslate"><span class="pre">ArrayBuffer</span></code> this is as simple as copying the
allocated buffer:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">zend_object_value</span><span class="w"> </span><span class="nf">array_buffer_clone</span><span class="p">(</span><span class="n">zval</span><span class="w"> </span><span class="o">*</span><span class="n">object</span><span class="w"> </span><span class="n">TSRMLS_DC</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">buffer_object</span><span class="w"> </span><span class="o">*</span><span class="n">old_object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zend_object_store_get_object</span><span class="p">(</span><span class="n">object</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">);</span>
<span class="w">    </span><span class="n">zend_object_value</span><span class="w"> </span><span class="n">new_object_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array_buffer_create_object</span><span class="p">(</span><span class="n">Z_OBJCE_P</span><span class="p">(</span><span class="n">object</span><span class="p">)</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">);</span>
<span class="w">    </span><span class="n">buffer_object</span><span class="w"> </span><span class="o">*</span><span class="n">new_object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zend_object_store_get_object_by_handle</span><span class="p">(</span>
<span class="w">        </span><span class="n">new_object_val</span><span class="p">.</span><span class="n">handle</span><span class="w"> </span><span class="n">TSRMLS_CC</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="n">zend_objects_clone_members</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">new_object</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">,</span><span class="w"> </span><span class="n">new_object_val</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">old_object</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">,</span><span class="w"> </span><span class="n">Z_OBJ_HANDLE_P</span><span class="p">(</span><span class="n">object</span><span class="p">)</span><span class="w"> </span><span class="n">TSRMLS_CC</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="n">new_object</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_object</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
<span class="w">    </span><span class="n">new_object</span><span class="o">-&gt;</span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_object</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">old_object</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">new_object</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">emalloc</span><span class="p">(</span><span class="n">old_object</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
<span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">new_object</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">old_object</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">old_object</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">new_object</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">old_object</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">old_object</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">new_object_val</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And finally getting everything together in <code class="docutils literal notranslate"><span class="pre">MINIT</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">ZEND_BEGIN_ARG_INFO_EX</span><span class="p">(</span><span class="n">arginfo_buffer_ctor</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">ZEND_ARG_INFO</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">)</span>
<span class="n">ZEND_END_ARG_INFO</span><span class="p">()</span>

<span class="k">const</span><span class="w"> </span><span class="n">zend_function_entry</span><span class="w"> </span><span class="n">array_buffer_functions</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">PHP_ME</span><span class="p">(</span><span class="n">ArrayBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">__construct</span><span class="p">,</span><span class="w"> </span><span class="n">arginfo_buffer_ctor</span><span class="p">,</span><span class="w"> </span><span class="n">ZEND_ACC_PUBLIC</span><span class="p">)</span>
<span class="w">    </span><span class="n">PHP_FE_END</span>
<span class="p">};</span>

<span class="n">MINIT_FUNCTION</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">zend_class_entry</span><span class="w"> </span><span class="n">tmp_ce</span><span class="p">;</span>

<span class="w">    </span><span class="n">INIT_CLASS_ENTRY</span><span class="p">(</span><span class="n">tmp_ce</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ArrayBuffer&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">array_buffer_functions</span><span class="p">);</span>
<span class="w">    </span><span class="n">array_buffer_ce</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zend_register_internal_class</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_ce</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">);</span>
<span class="w">    </span><span class="n">array_buffer_ce</span><span class="o">-&gt;</span><span class="n">create_object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array_buffer_create_object</span><span class="p">;</span>

<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">array_buffer_handlers</span><span class="p">,</span><span class="w"> </span><span class="n">zend_get_std_object_handlers</span><span class="p">(),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">zend_object_handlers</span><span class="p">));</span>
<span class="w">    </span><span class="n">array_buffer_handlers</span><span class="p">.</span><span class="n">clone_obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array_buffer_clone</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="the-buffer-views">
<h2>The buffer views<a class="headerlink" href="#the-buffer-views" title="Link to this heading">¶</a></h2>
<p>The buffer views will be a good bit more work. We’ll implement 8 different view classes which all share one
implementation, namely <code class="docutils literal notranslate"><span class="pre">Int8Array</span></code>, <code class="docutils literal notranslate"><span class="pre">UInt8Array</span></code>, <code class="docutils literal notranslate"><span class="pre">Int16Array</span></code>, <code class="docutils literal notranslate"><span class="pre">UInt16Array</span></code>, <code class="docutils literal notranslate"><span class="pre">Int32Array</span></code>, <code class="docutils literal notranslate"><span class="pre">UInt32Array</span></code>,
<code class="docutils literal notranslate"><span class="pre">FloatArray</span></code> and <code class="docutils literal notranslate"><span class="pre">DoubleArray</span></code>. The class registration code looks as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">zend_class_entry</span><span class="w"> </span><span class="o">*</span><span class="n">int8_array_ce</span><span class="p">;</span>
<span class="n">zend_class_entry</span><span class="w"> </span><span class="o">*</span><span class="n">uint8_array_ce</span><span class="p">;</span>
<span class="n">zend_class_entry</span><span class="w"> </span><span class="o">*</span><span class="n">int16_array_ce</span><span class="p">;</span>
<span class="n">zend_class_entry</span><span class="w"> </span><span class="o">*</span><span class="n">uint16_array_ce</span><span class="p">;</span>
<span class="n">zend_class_entry</span><span class="w"> </span><span class="o">*</span><span class="n">int32_array_ce</span><span class="p">;</span>
<span class="n">zend_class_entry</span><span class="w"> </span><span class="o">*</span><span class="n">uint32_array_ce</span><span class="p">;</span>
<span class="n">zend_class_entry</span><span class="w"> </span><span class="o">*</span><span class="n">float_array_ce</span><span class="p">;</span>
<span class="n">zend_class_entry</span><span class="w"> </span><span class="o">*</span><span class="n">double_array_ce</span><span class="p">;</span>

<span class="n">zend_object_handlers</span><span class="w"> </span><span class="n">array_buffer_view_handlers</span><span class="p">;</span>

<span class="cm">/* ... There will be a lot more code coming in between ... */</span>

<span class="n">PHP_MINIT_FUNCTION</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">zend_class_entry</span><span class="w"> </span><span class="n">tmp_ce</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* ... ArrayBuffer stuff here ... */</span>

<span class="cp">#define DEFINE_ARRAY_BUFFER_VIEW_CLASS(class_name, type)                      \</span>
<span class="cp">    INIT_CLASS_ENTRY(tmp_ce, #class_name, array_buffer_view_functions);       \</span>
<span class="cp">    type##_array_ce = zend_register_internal_class(&amp;tmp_ce TSRMLS_CC);        \</span>
<span class="cp">    type##_array_ce-&gt;create_object = array_buffer_view_create_object;         \</span>
<span class="cp">    zend_class_implements(type##_array_ce TSRMLS_CC, 1, zend_ce_arrayaccess);</span>

<span class="w">    </span><span class="n">DEFINE_ARRAY_BUFFER_VIEW_CLASS</span><span class="p">(</span><span class="n">Int8Array</span><span class="p">,</span><span class="w">   </span><span class="n">int8</span><span class="p">);</span>
<span class="w">    </span><span class="n">DEFINE_ARRAY_BUFFER_VIEW_CLASS</span><span class="p">(</span><span class="n">UInt8Array</span><span class="p">,</span><span class="w">  </span><span class="n">uint8</span><span class="p">);</span>
<span class="w">    </span><span class="n">DEFINE_ARRAY_BUFFER_VIEW_CLASS</span><span class="p">(</span><span class="n">Int16Array</span><span class="p">,</span><span class="w">  </span><span class="n">int16</span><span class="p">);</span>
<span class="w">    </span><span class="n">DEFINE_ARRAY_BUFFER_VIEW_CLASS</span><span class="p">(</span><span class="n">Uint16Array</span><span class="p">,</span><span class="w"> </span><span class="n">uint16</span><span class="p">);</span>
<span class="w">    </span><span class="n">DEFINE_ARRAY_BUFFER_VIEW_CLASS</span><span class="p">(</span><span class="n">Int32Array</span><span class="p">,</span><span class="w">  </span><span class="n">int32</span><span class="p">);</span>
<span class="w">    </span><span class="n">DEFINE_ARRAY_BUFFER_VIEW_CLASS</span><span class="p">(</span><span class="n">UInt32Array</span><span class="p">,</span><span class="w"> </span><span class="n">uint32</span><span class="p">);</span>
<span class="w">    </span><span class="n">DEFINE_ARRAY_BUFFER_VIEW_CLASS</span><span class="p">(</span><span class="n">FloatArray</span><span class="p">,</span><span class="w">  </span><span class="kt">float</span><span class="p">);</span>
<span class="w">    </span><span class="n">DEFINE_ARRAY_BUFFER_VIEW_CLASS</span><span class="p">(</span><span class="n">DoubleArray</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="p">);</span>

<span class="cp">#undef DEFINE_ARRAY_BUFFER_VIEW_CLASS</span>

<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">array_buffer_view_handlers</span><span class="p">,</span><span class="w"> </span><span class="n">zend_get_std_object_handlers</span><span class="p">(),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">zend_object_handlers</span><span class="p">));</span>
<span class="w">    </span><span class="n">array_buffer_view_handlers</span><span class="p">.</span><span class="n">clone_obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array_buffer_view_clone</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To avoid typing out the same code again and a again a temporary macro is used. It initializes the class entry (always
with the same functions), registers the class, assigns the create handler (which is also the same for all classes) and
implements the <code class="docutils literal notranslate"><span class="pre">ArrayAccess</span></code> interface. The macro uses the <code class="docutils literal notranslate"><span class="pre">#</span></code> (stringification) and <code class="docutils literal notranslate"><span class="pre">##</span></code> (token concatenation)
operators. [Note: Those will have to be explained somewhere. For now just Google them if you don’t already know their
meaning.]</p>
<p>The <code class="docutils literal notranslate"><span class="pre">array_buffer_view_functions</span></code> are declared as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">ZEND_BEGIN_ARG_INFO_EX</span><span class="p">(</span><span class="n">arginfo_buffer_view_ctor</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">ZEND_ARG_INFO</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">)</span>
<span class="n">ZEND_END_ARG_INFO</span><span class="p">()</span>

<span class="n">ZEND_BEGIN_ARG_INFO_EX</span><span class="p">(</span><span class="n">arginfo_buffer_view_offset</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">ZEND_ARG_INFO</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span>
<span class="n">ZEND_END_ARG_INFO</span><span class="p">()</span>

<span class="n">ZEND_BEGIN_ARG_INFO_EX</span><span class="p">(</span><span class="n">arginfo_buffer_view_offset_set</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="n">ZEND_ARG_INFO</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span>
<span class="w">    </span><span class="n">ZEND_ARG_INFO</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span>
<span class="n">ZEND_END_ARG_INFO</span><span class="p">()</span>

<span class="k">const</span><span class="w"> </span><span class="n">zend_function_entry</span><span class="w"> </span><span class="n">array_buffer_view_functions</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">PHP_ME_MAPPING</span><span class="p">(</span><span class="n">__construct</span><span class="p">,</span><span class="w"> </span><span class="n">array_buffer_view_ctor</span><span class="p">,</span><span class="w"> </span><span class="n">arginfo_buffer_view_ctor</span><span class="p">,</span><span class="w"> </span><span class="n">ZEND_ACC_PUBLIC</span><span class="p">)</span>

<span class="w">    </span><span class="cm">/* ArrayAccess */</span>
<span class="w">    </span><span class="n">PHP_ME_MAPPING</span><span class="p">(</span>
<span class="w">        </span><span class="n">offsetGet</span><span class="p">,</span><span class="w"> </span><span class="n">array_buffer_view_offset_get</span><span class="p">,</span><span class="w"> </span><span class="n">arginfo_buffer_view_offset</span><span class="p">,</span><span class="w"> </span><span class="n">ZEND_ACC_PUBLIC</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="n">PHP_ME_MAPPING</span><span class="p">(</span>
<span class="w">        </span><span class="n">offsetSet</span><span class="p">,</span><span class="w"> </span><span class="n">array_buffer_view_offset_set</span><span class="p">,</span><span class="w"> </span><span class="n">arginfo_buffer_view_offset_set</span><span class="p">,</span><span class="w"> </span><span class="n">ZEND_ACC_PUBLIC</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="n">PHP_ME_MAPPING</span><span class="p">(</span>
<span class="w">        </span><span class="n">offsetExists</span><span class="p">,</span><span class="w"> </span><span class="n">array_buffer_view_offset_exists</span><span class="p">,</span><span class="w"> </span><span class="n">arginfo_buffer_view_offset</span><span class="p">,</span><span class="w"> </span><span class="n">ZEND_ACC_PUBLIC</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="n">PHP_ME_MAPPING</span><span class="p">(</span>
<span class="w">        </span><span class="n">offsetUnset</span><span class="p">,</span><span class="w"> </span><span class="n">array_buffer_view_offset_unset</span><span class="p">,</span><span class="w"> </span><span class="n">arginfo_buffer_view_offset</span><span class="p">,</span><span class="w"> </span><span class="n">ZEND_ACC_PUBLIC</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="n">PHP_FE_END</span>
<span class="p">};</span>
</pre></div>
</div>
<p>One new thing here is that instead of <code class="docutils literal notranslate"><span class="pre">PHP_ME</span></code> the macro <code class="docutils literal notranslate"><span class="pre">PHP_ME_MAPPING</span></code> is used. The difference is that
<code class="docutils literal notranslate"><span class="pre">PHP_ME</span></code> maps to a <code class="docutils literal notranslate"><span class="pre">PHP_METHOD</span></code> whereas <code class="docutils literal notranslate"><span class="pre">PHP_ME_MAPPING</span></code> maps to a <code class="docutils literal notranslate"><span class="pre">PHP_FUNCTION</span></code>. An example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PHP_ME</span><span class="p">(</span><span class="n">ArrayBufferView</span><span class="p">,</span><span class="w"> </span><span class="n">offsetGet</span><span class="p">,</span><span class="w"> </span><span class="n">arginfo_buffer_view_offset</span><span class="p">,</span><span class="w"> </span><span class="n">ZEND_ACC_PUBLIC</span><span class="p">)</span>
<span class="cm">/* maps to */</span>
<span class="n">PHP_METHOD</span><span class="p">(</span><span class="n">ArrayBufferView</span><span class="p">,</span><span class="w"> </span><span class="n">offsetGet</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>

<span class="n">PHP_ME_MAPPING</span><span class="p">(</span>
<span class="w">    </span><span class="n">offsetGet</span><span class="p">,</span><span class="w"> </span><span class="n">array_buffer_view_offset_get</span><span class="p">,</span><span class="w"> </span><span class="n">arginfo_buffer_view_offset</span><span class="p">,</span><span class="w"> </span><span class="n">ZEND_ACC_PUBLIC</span>
<span class="p">)</span>
<span class="cm">/* maps to */</span>
<span class="n">PHP_FUNCTION</span><span class="p">(</span><span class="n">array_buffer_view_offset_get</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
<p>What you have to realize here is that <code class="docutils literal notranslate"><span class="pre">PHP_FUNCTION</span></code> and <code class="docutils literal notranslate"><span class="pre">PHP_METHOD</span></code> really have nothing to do with PHP functions
or methods, they are just macros that define a function with a certain name and a certain set of parameters. That’s
why you can register a “function” as a method (and you can also define a method with one name, but register it with
a different). This is in particular useful when you want to support both an OO interface and a procedural API.</p>
<p>In this case I chose to use <code class="docutils literal notranslate"><span class="pre">PHP_ME_MAPPING</span></code> to signal that there is no real <code class="docutils literal notranslate"><span class="pre">ArrayBufferView</span></code> class, rather there
is a set of functions that is shared by several classes.</p>
<p>Getting back to the implementation one has to consider what the internal structure for buffer views needs to store:
Firstly it needs a way to discriminate the different view classes, i.e. some kind of type tag. Secondly it needs to
store the zval of the buffer it operates on. And thirdly there has to be a member that can be used to access the buffer
as different types.</p>
<p>Additionally our implementation will store the offset and length of the view. Those are used to create views that don’t
use the entire buffer. E.g. <code class="docutils literal notranslate"><span class="pre">new</span> <span class="pre">Int32Array($buffer,</span> <span class="pre">18,</span> <span class="pre">24)</span></code> should create a view that starts 18 bytes into the
buffer and contains a total of 24 elements.</p>
<p>This is how the resulting structure could look like:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">_buffer_view_type</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">buffer_view_int8</span><span class="p">,</span>
<span class="w">    </span><span class="n">buffer_view_uint8</span><span class="p">,</span>
<span class="w">    </span><span class="n">buffer_view_int16</span><span class="p">,</span>
<span class="w">    </span><span class="n">buffer_view_uint16</span><span class="p">,</span>
<span class="w">    </span><span class="n">buffer_view_int32</span><span class="p">,</span>
<span class="w">    </span><span class="n">buffer_view_uint32</span><span class="p">,</span>
<span class="w">    </span><span class="n">buffer_view_float</span><span class="p">,</span>
<span class="w">    </span><span class="n">buffer_view_double</span>
<span class="p">}</span><span class="w"> </span><span class="n">buffer_view_type</span><span class="p">;</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">_buffer_view_object</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">zend_object</span><span class="w"> </span><span class="n">std</span><span class="p">;</span>

<span class="w">    </span><span class="n">zval</span><span class="w"> </span><span class="o">*</span><span class="n">buffer_zval</span><span class="p">;</span>

<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int8_t</span><span class="w">   </span><span class="o">*</span><span class="n">as_int8</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint8_t</span><span class="w">  </span><span class="o">*</span><span class="n">as_uint8</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int16_t</span><span class="w">  </span><span class="o">*</span><span class="n">as_int16</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint16_t</span><span class="w"> </span><span class="o">*</span><span class="n">as_uint16</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int32_t</span><span class="w">  </span><span class="o">*</span><span class="n">as_int32</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">as_uint32</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w">    </span><span class="o">*</span><span class="n">as_float</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w">   </span><span class="o">*</span><span class="n">as_double</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">buf</span><span class="p">;</span>

<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">length</span><span class="p">;</span>

<span class="w">    </span><span class="n">buffer_view_type</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">buffer_view_object</span><span class="p">;</span>
</pre></div>
</div>
<p>The exact-width integer types used above (<code class="docutils literal notranslate"><span class="pre">int8_t</span></code>, …) are part of the <code class="docutils literal notranslate"><span class="pre">stdint.h</span></code> header. Sadly this header isn’t
always available on Windows, so a replacement header (that PHP natively provides) has to be included in this case:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#if defined(PHP_WIN32)</span>
<span class="cp">#</span><span class="w"> </span><span class="cp">include</span><span class="w"> </span><span class="cpf">&quot;win32/php_stdint.h&quot;</span>
<span class="cp">#elif defined(HAVE_STDINT_H)</span>
<span class="cp">#</span><span class="w"> </span><span class="cp">include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="cp">#endif</span>
</pre></div>
</div>
<p>The free and create handlers for the above data structure are rather straightforward again:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">array_buffer_view_free_object_storage</span><span class="p">(</span><span class="n">buffer_view_object</span><span class="w"> </span><span class="o">*</span><span class="n">intern</span><span class="w"> </span><span class="n">TSRMLS_DC</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">zend_object_std_dtor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">std</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">buffer_zval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">zval_ptr_dtor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">buffer_zval</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">efree</span><span class="p">(</span><span class="n">intern</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">zend_object_value</span><span class="w"> </span><span class="nf">array_buffer_view_create_object</span><span class="p">(</span><span class="n">zend_class_entry</span><span class="w"> </span><span class="o">*</span><span class="n">class_type</span><span class="w"> </span><span class="n">TSRMLS_DC</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">zend_object_value</span><span class="w"> </span><span class="n">retval</span><span class="p">;</span>

<span class="w">    </span><span class="n">buffer_view_object</span><span class="w"> </span><span class="o">*</span><span class="n">intern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">emalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer_view_object</span><span class="p">));</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">intern</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer_view_object</span><span class="p">));</span>

<span class="w">    </span><span class="n">zend_object_std_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">,</span><span class="w"> </span><span class="n">class_type</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">);</span>
<span class="w">    </span><span class="n">object_properties_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">,</span><span class="w"> </span><span class="n">class_type</span><span class="p">);</span>

<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">zend_class_entry</span><span class="w"> </span><span class="o">*</span><span class="n">base_class_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">class_type</span><span class="p">;</span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">base_class_type</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">base_class_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base_class_type</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">base_class_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">int8_array_ce</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer_view_int8</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">base_class_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">uint8_array_ce</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer_view_uint8</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">base_class_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">int16_array_ce</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer_view_uint16</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">base_class_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">int32_array_ce</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer_view_int32</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">base_class_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">uint32_array_ce</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer_view_uint32</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">base_class_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">float_array_ce</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer_view_float</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">base_class_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">double_array_ce</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer_view_double</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="cm">/* Should never happen */</span>
<span class="w">            </span><span class="n">zend_error</span><span class="p">(</span><span class="n">E_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Buffer view does not have a valid base class&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">retval</span><span class="p">.</span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zend_objects_store_put</span><span class="p">(</span><span class="n">intern</span><span class="p">,</span>
<span class="w">        </span><span class="p">(</span><span class="n">zend_objects_store_dtor_t</span><span class="p">)</span><span class="w"> </span><span class="n">zend_objects_destroy_object</span><span class="p">,</span>
<span class="w">        </span><span class="p">(</span><span class="n">zend_objects_free_object_storage_t</span><span class="p">)</span><span class="w"> </span><span class="n">array_buffer_view_free_object_storage</span><span class="p">,</span>
<span class="w">        </span><span class="nb">NULL</span><span class="w"> </span><span class="n">TSRMLS_CC</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="n">retval</span><span class="p">.</span><span class="n">handlers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">array_buffer_view_handlers</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">create_object</span></code> handler contains some extra code to first find the base class of the instantiated class and then
figure out which buffer view type it corresponds to. It’s necessary to go up the <code class="docutils literal notranslate"><span class="pre">parent</span></code> chain to make sure that
everything will work fine if one of the classes is extended. The creation handler doesn’t do particularly much, the main
work happens in the constructor:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PHP_FUNCTION</span><span class="p">(</span><span class="n">array_buffer_view_ctor</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">zval</span><span class="w"> </span><span class="o">*</span><span class="n">buffer_zval</span><span class="p">;</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">buffer_view_object</span><span class="w"> </span><span class="o">*</span><span class="n">view_intern</span><span class="p">;</span>
<span class="w">    </span><span class="n">buffer_object</span><span class="w"> </span><span class="o">*</span><span class="n">buffer_intern</span><span class="p">;</span>
<span class="w">    </span><span class="n">zend_error_handling</span><span class="w"> </span><span class="n">error_handling</span><span class="p">;</span>

<span class="w">    </span><span class="n">zend_replace_error_handling</span><span class="p">(</span><span class="n">EH_THROW</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error_handling</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">zend_parse_parameters</span><span class="p">(</span>
<span class="w">            </span><span class="n">ZEND_NUM_ARGS</span><span class="p">()</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;O|ll&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">buffer_zval</span><span class="p">,</span><span class="w"> </span><span class="n">array_buffer_ce</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">length</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FAILURE</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">zend_restore_error_handling</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error_handling</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">zend_restore_error_handling</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error_handling</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">);</span>

<span class="w">    </span><span class="n">view_intern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zend_object_store_get_object</span><span class="p">(</span><span class="n">getThis</span><span class="p">()</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">);</span>
<span class="w">    </span><span class="n">buffer_intern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zend_object_store_get_object</span><span class="p">(</span><span class="n">buffer_zval</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">zend_throw_exception</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Offset must be non-negative&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">buffer_intern</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">zend_throw_exception</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Offset has to be smaller than the buffer length&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">length</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">zend_throw_exception</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Length must be positive or zero&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">view_intern</span><span class="o">-&gt;</span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<span class="w">    </span><span class="n">view_intern</span><span class="o">-&gt;</span><span class="n">buffer_zval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer_zval</span><span class="p">;</span>
<span class="w">    </span><span class="n">Z_ADDREF_P</span><span class="p">(</span><span class="n">buffer_zval</span><span class="p">);</span>

<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bytes_per_element</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer_view_get_bytes_per_element</span><span class="p">(</span><span class="n">view_intern</span><span class="p">);</span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">max_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">buffer_intern</span><span class="o">-&gt;</span><span class="n">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">bytes_per_element</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">view_intern</span><span class="o">-&gt;</span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_length</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">max_length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">zend_throw_exception</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Length is larger than the buffer&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">view_intern</span><span class="o">-&gt;</span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">view_intern</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">as_int8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer_intern</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
<span class="w">    </span><span class="n">view_intern</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">as_int8</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The code is mostly error checking, with a few assignments to the internal structure sprinkled in between. The code also
uses the helper function <code class="docutils literal notranslate"><span class="pre">buffer_view_get_bytes_per_element</span></code> which does exactly what it says:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">size_t</span><span class="w"> </span><span class="nf">buffer_view_get_bytes_per_element</span><span class="p">(</span><span class="n">buffer_view_object</span><span class="w"> </span><span class="o">*</span><span class="n">intern</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">buffer_view_int8</span><span class="p">:</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">buffer_view_uint8</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">buffer_view_int16</span><span class="p">:</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">buffer_view_uint16</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">buffer_view_int32</span><span class="p">:</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">buffer_view_uint32</span><span class="p">:</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">buffer_view_float</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">buffer_view_double</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span>
<span class="w">            </span><span class="cm">/* Should never happen */</span>
<span class="w">            </span><span class="n">zend_error_noreturn</span><span class="p">(</span><span class="n">E_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Invalid buffer view type&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The only missing piece from the construction logic is the clone handler, which copies all internal members and adds a
ref to the buffer zval:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">zend_object_value</span><span class="w"> </span><span class="nf">array_buffer_view_clone</span><span class="p">(</span><span class="n">zval</span><span class="w"> </span><span class="o">*</span><span class="n">object</span><span class="w"> </span><span class="n">TSRMLS_DC</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">buffer_view_object</span><span class="w"> </span><span class="o">*</span><span class="n">old_object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zend_object_store_get_object</span><span class="p">(</span><span class="n">object</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">);</span>
<span class="w">    </span><span class="n">zend_object_value</span><span class="w"> </span><span class="n">new_object_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array_buffer_view_create_object</span><span class="p">(</span>
<span class="w">        </span><span class="n">Z_OBJCE_P</span><span class="p">(</span><span class="n">object</span><span class="p">)</span><span class="w"> </span><span class="n">TSRMLS_CC</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="n">buffer_view_object</span><span class="w"> </span><span class="o">*</span><span class="n">new_object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zend_object_store_get_object_by_handle</span><span class="p">(</span>
<span class="w">        </span><span class="n">new_object_val</span><span class="p">.</span><span class="n">handle</span><span class="w"> </span><span class="n">TSRMLS_CC</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="n">zend_objects_clone_members</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">new_object</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">,</span><span class="w"> </span><span class="n">new_object_val</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">old_object</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">,</span><span class="w"> </span><span class="n">Z_OBJ_HANDLE_P</span><span class="p">(</span><span class="n">object</span><span class="p">)</span><span class="w"> </span><span class="n">TSRMLS_CC</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="n">new_object</span><span class="o">-&gt;</span><span class="n">buffer_zval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_object</span><span class="o">-&gt;</span><span class="n">buffer_zval</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">new_object</span><span class="o">-&gt;</span><span class="n">buffer_zval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Z_ADDREF_P</span><span class="p">(</span><span class="n">new_object</span><span class="o">-&gt;</span><span class="n">buffer_zval</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">new_object</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">as_int8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_object</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">as_int8</span><span class="p">;</span>
<span class="w">    </span><span class="n">new_object</span><span class="o">-&gt;</span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_object</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
<span class="w">    </span><span class="n">new_object</span><span class="o">-&gt;</span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_object</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
<span class="w">    </span><span class="n">new_object</span><span class="o">-&gt;</span><span class="n">type</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">old_object</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">new_object_val</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now that all the formalisms are out of the way, we can start working on the actual functionality: Accessing values at
certain offsets. For that we need two helper functions for getting and setting the offset depending on the type of the
view. This basically comes down to switching through all the different types and using the respective member from
the buffer union:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">zval</span><span class="w"> </span><span class="o">*</span><span class="nf">buffer_view_offset_get</span><span class="p">(</span><span class="n">buffer_view_object</span><span class="w"> </span><span class="o">*</span><span class="n">intern</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">zval</span><span class="w"> </span><span class="o">*</span><span class="n">retval</span><span class="p">;</span>
<span class="w">    </span><span class="n">MAKE_STD_ZVAL</span><span class="p">(</span><span class="n">retval</span><span class="p">);</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">buffer_view_int8</span><span class="p">:</span>
<span class="w">            </span><span class="n">ZVAL_LONG</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span><span class="w"> </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">as_int8</span><span class="p">[</span><span class="n">offset</span><span class="p">]);</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">buffer_view_uint8</span><span class="p">:</span>
<span class="w">            </span><span class="n">ZVAL_LONG</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span><span class="w"> </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">as_uint8</span><span class="p">[</span><span class="n">offset</span><span class="p">]);</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">buffer_view_int16</span><span class="p">:</span>
<span class="w">            </span><span class="n">ZVAL_LONG</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span><span class="w"> </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">as_int16</span><span class="p">[</span><span class="n">offset</span><span class="p">]);</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">buffer_view_uint16</span><span class="p">:</span>
<span class="w">            </span><span class="n">ZVAL_LONG</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span><span class="w"> </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">as_uint16</span><span class="p">[</span><span class="n">offset</span><span class="p">]);</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">buffer_view_int32</span><span class="p">:</span>
<span class="w">            </span><span class="n">ZVAL_LONG</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span><span class="w"> </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">as_int32</span><span class="p">[</span><span class="n">offset</span><span class="p">]);</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">buffer_view_uint32</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">as_uint32</span><span class="p">[</span><span class="n">offset</span><span class="p">];</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">LONG_MAX</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">ZVAL_LONG</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">ZVAL_DOUBLE</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">buffer_view_float</span><span class="p">:</span>
<span class="w">            </span><span class="n">ZVAL_DOUBLE</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span><span class="w"> </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">as_float</span><span class="p">[</span><span class="n">offset</span><span class="p">]);</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">buffer_view_double</span><span class="p">:</span>
<span class="w">            </span><span class="n">ZVAL_DOUBLE</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span><span class="w"> </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">as_double</span><span class="p">[</span><span class="n">offset</span><span class="p">]);</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span>
<span class="w">            </span><span class="cm">/* Should never happen */</span>
<span class="w">            </span><span class="n">zend_error_noreturn</span><span class="p">(</span><span class="n">E_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Invalid buffer view type&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">buffer_view_offset_set</span><span class="p">(</span><span class="n">buffer_view_object</span><span class="w"> </span><span class="o">*</span><span class="n">intern</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">zval</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">buffer_view_float</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">buffer_view_double</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Z_ADDREF_P</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="w">        </span><span class="n">convert_to_double_ex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">buffer_view_float</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">as_float</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Z_DVAL_P</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">as_double</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Z_DVAL_P</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">zval_ptr_dtor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Z_ADDREF_P</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="w">        </span><span class="n">convert_to_long_ex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">buffer_view_int8</span><span class="p">:</span>
<span class="w">                </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">as_int8</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Z_LVAL_P</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">buffer_view_uint8</span><span class="p">:</span>
<span class="w">                </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">as_uint8</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Z_LVAL_P</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">buffer_view_int16</span><span class="p">:</span>
<span class="w">                </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">as_int16</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Z_LVAL_P</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">buffer_view_uint16</span><span class="p">:</span>
<span class="w">                </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">as_uint16</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Z_LVAL_P</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">buffer_view_int32</span><span class="p">:</span>
<span class="w">                </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">as_int32</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Z_LVAL_P</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">buffer_view_uint32</span><span class="p">:</span>
<span class="w">                </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">as_uint32</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Z_LVAL_P</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">default</span><span class="o">:</span>
<span class="w">                </span><span class="cm">/* Should never happen */</span>
<span class="w">                </span><span class="n">zend_error</span><span class="p">(</span><span class="n">E_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Invalid buffer view type&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">zval_ptr_dtor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Implementing the <code class="docutils literal notranslate"><span class="pre">ArrayAccess</span></code> interface is now only matter of doing a bit of bounds checking and dispatching to the
above helpers (as well as the usual method boilerplate). Here’s how the <code class="docutils literal notranslate"><span class="pre">offsetGet</span></code> method could be implemented:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PHP_FUNCTION</span><span class="p">(</span><span class="n">array_buffer_view_offset_get</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">buffer_view_object</span><span class="w"> </span><span class="o">*</span><span class="n">intern</span><span class="p">;</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<span class="w">    </span><span class="n">zval</span><span class="w"> </span><span class="o">*</span><span class="n">retval</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">zend_parse_parameters</span><span class="p">(</span><span class="n">ZEND_NUM_ARGS</span><span class="p">()</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;l&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FAILURE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">intern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zend_object_store_get_object</span><span class="p">(</span><span class="n">getThis</span><span class="p">()</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">intern</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">zend_throw_exception</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Offset is outside the buffer range&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">TSRMLS_CC</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer_view_offset_get</span><span class="p">(</span><span class="n">intern</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span>
<span class="w">    </span><span class="n">RETURN_ZVAL</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The remaining three <code class="docutils literal notranslate"><span class="pre">offsetSet</span></code>, <code class="docutils literal notranslate"><span class="pre">offsetExists</span></code> and <code class="docutils literal notranslate"><span class="pre">offsetUnset</span></code> methods are pretty much the same, so I’ll just
leave them as an exercise to the reader.</p>
<p>The implementation outlined above is about 600 lines of code long and implements the most important parts of
JavaScript’s pretty awesome buffer/view system.</p>
<p>But the current implementation does not yet integrate well with PHP. It only implements <code class="docutils literal notranslate"><span class="pre">ArrayAccess</span></code>, but it can’t
be iterated over, can’t be counted and so on. Implementing those interactions is what the next section is about.</p>
</section>
</section>


      </div>
      <div class="bottomnav" role="navigation" aria-label="Bottom">
      
        <p>
        «&#160;&#160;<a href="custom_object_storage.html">Custom object storage</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="object_handlers.html">Object handlers</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer feedback">
        The repository for this book is available on <a href="https://github.com/phpinternalsbook/PHP-Internals-Book">GitHub</a>.
        <br/><br/>
        <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
            <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" />
        </a>
        <br />
        The PHP internals book is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
    </div>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-41617167-1', 'phpinternalsbook.com');
      ga('send', 'pageview');
    </script>

  </body>
</html>