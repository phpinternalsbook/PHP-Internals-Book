<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Zend Extensions &#8212; PHP Internals Book</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/haiku.css?v=fce32b03" />
    <link rel="stylesheet" type="text/css" href="../../_static/style.css?v=38da9290" />
    <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Memory management" href="../memory_management.html" />
    <link rel="prev" title="Declaring and using INI settings" href="ini_settings.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../index.html">
          <span>PHP Internals Book</span></a></h1>
        <h2 class="heading"><span>Zend Extensions</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="Top">
      
        <p>
        «&#160;&#160;<a href="ini_settings.html">Declaring and using INI settings</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="../memory_management.html">Memory management</a>&#160;&#160;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <section id="zend-extensions">
<h1>Zend Extensions<a class="headerlink" href="#zend-extensions" title="Link to this heading">¶</a></h1>
<p>PHP knows two kinds of extensions :</p>
<ul class="simple">
<li><p>The PHP extensions, the most commonly used</p></li>
<li><p>The Zend extensions, more uncommon, allows other hooks</p></li>
</ul>
<p>This chapter will detail what are the main differences between Zend extensions and PHP extensions, when you should use
one instead of the other, and how to build hybrid extensions, aka extensions being both PHP and Zend at the same time
(and why do that).</p>
<section id="on-differences-between-php-and-zend-extensions">
<h2>On differences between PHP and Zend extensions<a class="headerlink" href="#on-differences-between-php-and-zend-extensions" title="Link to this heading">¶</a></h2>
<p>Just to say. Into PHP’s source code, PHP extensions are named as <strong>“PHP modules”</strong>, whereas Zend extensions are called
<strong>“Zend extensions”</strong>.</p>
<p>So into PHP’s heart, if you read the “extension” keyword, you should first think about a Zend extension. And if you
read the “module” keyword, you may think about a PHP extension.</p>
<p>In traditional life, we talk about <em>“PHP extensions”</em> versus <em>“Zend extensions”</em>.</p>
<p>The thing that differentiate them is the way they are loaded :</p>
<ul class="simple">
<li><p>PHP extensions (aka PHP “modules”) are loaded in INI files as a <em>“extension=pib.so”</em> line</p></li>
<li><p>Zend extensions are loaded in INI files as a <em>“zend_extension=pib.so”</em> line</p></li>
</ul>
<p>That’s the only visible difference we see from PHP userland.</p>
<p>But that’s a different story from internal point of view.</p>
</section>
<section id="what-is-a-zend-extension">
<h2>What is a Zend extension ?<a class="headerlink" href="#what-is-a-zend-extension" title="Link to this heading">¶</a></h2>
<p>First of all, Zend extensions are compiled and loaded the same way as PHP extensions. Thus, if you haven’t yet read the
<a class="reference internal" href="../build_system/building_extensions.html"><span class="doc">building PHP extensions</span></a> chapter, you should have a look as it is valid
also for Zend extensions.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If not done, <a class="reference internal" href="../extensions_design.html"><span class="doc">get some information about PHP extensions</span></a> as we will compare
against them here. Zend extensions share a very big part of concepts with PHP extensions.</p>
</div>
<p>Here is a Zend extension. Note that you need to publish not one but two structures for the engine to load your Zend
extension:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Main Zend extension structure */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">_zend_extension</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span><span class="w">                                           </span><span class="cm">/*</span>
<span class="cm">    char *version;                                         * Some infos</span>
<span class="cm">    char *author;                                          *</span>
<span class="cm">    char *URL;                                             *</span>
<span class="cm">    char *copyright;                                       */</span>

<span class="w">    </span><span class="n">startup_func_t</span><span class="w"> </span><span class="n">startup</span><span class="p">;</span><span class="w">                               </span><span class="cm">/*</span>
<span class="cm">    shutdown_func_t shutdown;                              *  Specific branching lifetime points</span>
<span class="cm">    activate_func_t activate;                              *  ( Hooks )</span>
<span class="cm">    deactivate_func_t deactivate;                          */</span>

<span class="w">    </span><span class="n">message_handler_func_t</span><span class="w"> </span><span class="n">message_handler</span><span class="p">;</span><span class="w">               </span><span class="cm">/* Hook called on zend_extension registration */</span>

<span class="w">    </span><span class="n">op_array_handler_func_t</span><span class="w"> </span><span class="n">op_array_handler</span><span class="p">;</span><span class="w">             </span><span class="cm">/* Hook called just after Zend compilation */</span>

<span class="w">    </span><span class="n">statement_handler_func_t</span><span class="w"> </span><span class="n">statement_handler</span><span class="p">;</span><span class="w">           </span><span class="cm">/*</span>
<span class="cm">    fcall_begin_handler_func_t fcall_begin_handler;        *  Hooks called through the Zend VM as specific OPCodes</span>
<span class="cm">    fcall_end_handler_func_t fcall_end_handler;            */</span>

<span class="w">    </span><span class="n">op_array_ctor_func_t</span><span class="w"> </span><span class="n">op_array_ctor</span><span class="p">;</span><span class="w">                   </span><span class="cm">/* Hook called on OPArray construction */</span>
<span class="w">    </span><span class="n">op_array_dtor_func_t</span><span class="w"> </span><span class="n">op_array_dtor</span><span class="p">;</span><span class="w">                   </span><span class="cm">/* Hook called on OPArray destruction */</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">api_no_check</span><span class="p">)(</span><span class="kt">int</span><span class="w"> </span><span class="n">api_no</span><span class="p">);</span><span class="w">                      </span><span class="cm">/* Checks against zend_extension incompatibilities</span>
<span class="cm">    int (*build_id_check)(const char* build_id);           */</span>

<span class="w">    </span><span class="n">op_array_persist_calc_func_t</span><span class="w"> </span><span class="n">op_array_persist_calc</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Hooks called if the zend_extension extended the</span>
<span class="cm">    op_array_persist_func_t op_array_persist;              * OPArray structure and has some SHM data to declare</span>
<span class="cm">                                                           */</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">reserved5</span><span class="p">;</span><span class="w">                                      </span><span class="cm">/*</span>
<span class="cm">    void *reserved6;                                       * Do what you want with those free pointers</span>
<span class="cm">    void *reserved7;                                       *</span>
<span class="cm">    void *reserved8;                                       */</span>

<span class="w">    </span><span class="n">DL_HANDLE</span><span class="w"> </span><span class="n">handle</span><span class="p">;</span><span class="w">                                     </span><span class="cm">/* dlopen() returned handle */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">resource_number</span><span class="p">;</span><span class="w">                                  </span><span class="cm">/* internal number used to manage that extension */</span>
<span class="p">};</span>

<span class="cm">/* Structure used when the Zend extension gets loaded into the engine */</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">_zend_extension_version_info</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">zend_extension_api_no</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">build_id</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">zend_extension_version_info</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As always, read the source. Zend extensions are managed into
<a class="reference external" href="https://github.com/php/php-src/blob/57dba0e2f5e39f6b05031317048e39d463243cc3/Zend/zend_extensions.c">Zend/zend_extension.c</a> (and .h)</p>
</div>
<p>Like you can notice, Zend extensions are more complex than PHP extensions, as they got more hooks, and those are much
closer to the <a class="reference internal" href="../zend_engine.html"><span class="doc">Zend engine and its Virtual Machine</span></a> (The most complex parts of the whole PHP
source code).</p>
</section>
<section id="why-need-a-zend-extension">
<h2>Why need a Zend extension ?<a class="headerlink" href="#why-need-a-zend-extension" title="Link to this heading">¶</a></h2>
<p>Let us warn you : until you have <strong>very advanced</strong> knowledge on PHP internal’s Vritual Machine, and until you need to
hook deep into it, you shouldn’t need a Zend extension, but a PHP extension will be enough.</p>
<p>Today’s most commonly known Zend extensions into PHP’s world are opcache, Xdebug, phpdbg and Blackfire. But you know
dozens of PHP extensions next to that don’t you ?! That’s a clear sign that :</p>
<ul class="simple">
<li><p>You should not need a Zend extension for a very big part of your problematics</p></li>
<li><p>Zend extensions can also be used as PHP extensions (more on that later)</p></li>
<li><p>A PHP extension still can do a lot of things.</p></li>
<li><p>Usually, Zend extensions are needed for two kinds of tasks : debuggers and profilers.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is no <a class="reference internal" href="extension_skeleton.html"><span class="doc">skeleton generator</span></a> for Zend extensions, like for PHP extensions.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>With Zend extensions, no generator, no help. Zend extensions are reserved to <strong>advanced programmers</strong>,
they are more complex to understand, they got deeper-engine behaviors and usually require an advanced
knowledge of PHP’s internal machinery.</p>
</div>
<p>Basically, if you need to create a debugger, you’ll need a Zend extension. For profilers, you can make some as
traditional PHP extensions, that can work and that depends on your needs.</p>
<p>Also, if you need to master extensions loading order, Zend extensions will help (we’ll see that).</p>
<p>Finally, if your goal is “just” to <em>add</em> some new concepts (functions, classes, constants, etc…) to PHP, you’ll use a
PHP extension, but if you need to <em>change</em> a current behavior of PHP, probably a Zend extension will be better.</p>
<p>We can’t give rules here, but we can explain how all that stuff works, so that you get your own idea of the
capabilities brought by Zend extensions against PHP extensions.</p>
<p>Also, you may create an <em>hybrid</em> extension, which is both a Zend extension <em>and</em> a PHP extension (this is tricky but
perfectly valid and allows you to program in both “worlds” at the same time).</p>
</section>
<section id="api-versions-and-conflicts-management">
<h2>API versions and conflicts management<a class="headerlink" href="#api-versions-and-conflicts-management" title="Link to this heading">¶</a></h2>
<p>You know that PHP extensions check against several rules before loading, to know if they are compatible with the PHP
version you try to load them on. This has been detailed into
<a class="reference internal" href="../build_system/building_extensions.html"><span class="doc">the chapter about building PHP extensions</span></a>.</p>
<p>For Zend extension, the same rules apply, but a little bit differently : it will use the
<code class="docutils literal notranslate"><span class="pre">zend_extension_version_info</span></code> structure you published to know what to do.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">zend_extension_version_info</span></code> structure you declare contain only two information that the engine will use when
it starts loading your Zend extension :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ZEND_EXTENSION_API_NO</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ZEND_EXTENSION_BUILD_ID</span></code></p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">ZEND_EXTENSION_API_NO</span></code> is checked when your Zend extension is loaded. But the difference is that if this number
doesn’t match your Zend extension’s, you still have a chance to get loaded. The engine will call for your
<code class="docutils literal notranslate"><span class="pre">api_no_check()</span></code> hook, if you declared one, and will pass it the current PHP runtime <code class="docutils literal notranslate"><span class="pre">ZEND_EXTENSION_API_NO</span></code>. Here,
you must tell if you support that API number, or not, simply by returning that info to the engine. If you don’t support,
the engine won’t load your extension and print a warning message about that.</p>
<p>The same applies to the other ABI settings, such as <code class="docutils literal notranslate"><span class="pre">ZEND_DEBUG</span></code>, or <code class="docutils literal notranslate"><span class="pre">ZTS</span></code>. Where PHP extensions will refuse to
load if there is a mismatch, Zend extensions are given a chance to load as the engine checks against
<code class="docutils literal notranslate"><span class="pre">build_id_check()</span></code> hook and pass it the <code class="docutils literal notranslate"><span class="pre">ZEND_EXTENSION_BUILD_ID</span></code>. Here again, you say if you are compatible or not.
Here again, if you say “no”, the engine won’t load your extension and print a warning message about that.</p>
<p>Remember that we detail how API and ABI is numbered,
<a class="reference internal" href="../build_system/building_extensions.html"><span class="doc">in the chapter about building PHP extensions</span></a>.</p>
<p>Those abilities to force things against the engine are rarely used in practice.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You see how more complex Zend extensions are compared to PHP extensions ? The engine is less restrictive, and
it supposes that you know what you’re doing, for the best or the worst.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Zend extensions should really be developed by experienced and advanced programmers, as the engine is
weaker about its checks. It clearly supposes that you master what you’re doing.</p>
</div>
<p>To sum things up about API compatibility, well, every step is detailed in
<a class="reference external" href="https://github.com/php/php-src/blob/57dba0e2f5e39f6b05031317048e39d463243cc3/Zend/zend_extensions.c#L67">zend_load_extension()</a>.</p>
<p>Then comes the problem of Zend extensions conflicts. One may be incompatible with an other, and to master that, every
Zend extension has got a hook called <code class="docutils literal notranslate"><span class="pre">message_handler</span></code>. If declared, this hook is triggered on every already loaded
extension when another Zend extension gets loaded. You are passed a pointer to its <code class="docutils literal notranslate"><span class="pre">zend_extension</span></code> structure, and you
may then detect which one it is, and abort if you think you’ll conflict with it. This is something rarely used in
practice as well.</p>
</section>
<section id="zend-extensions-lifetime-hooks">
<h2>Zend extensions lifetime hooks<a class="headerlink" href="#zend-extensions-lifetime-hooks" title="Link to this heading">¶</a></h2>
<p>If you remember about <a class="reference internal" href="php_lifecycle.html"><span class="doc">the PHP lifecycle</span></a> (you should read the dedicated chapter), well, Zend
extensions plug into that lifecycle this way:</p>
<img alt="../../_images/php_extensions_lifecycle_full.png" class="align-center" src="../../_images/php_extensions_lifecycle_full.png" />
<p>We can notice that our <code class="docutils literal notranslate"><span class="pre">api_no_check()</span></code>, <code class="docutils literal notranslate"><span class="pre">build_id_check()</span></code> and <code class="docutils literal notranslate"><span class="pre">message_handler()</span></code> check hooks are only triggered
when PHP starts up. Those later three hooks are detailed in the preceding part (above).</p>
<p>Then the <strong>important</strong> thing to remember :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MINIT()</span></code> is triggered on PHP extensions <strong>before</strong> Zend extensions (<code class="docutils literal notranslate"><span class="pre">startup()</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RINIT()</span></code> is triggered on Zend extensions (<code class="docutils literal notranslate"><span class="pre">activate()</span></code>) <strong>before</strong> PHP extensions.</p></li>
<li><p>Zend extensions request shutdown procedure (<code class="docutils literal notranslate"><span class="pre">deactivate()</span></code>) is called <strong>in between</strong> <code class="docutils literal notranslate"><span class="pre">RSHUTDOWN()</span></code> and
<code class="docutils literal notranslate"><span class="pre">PRSHUTDOWN()</span></code> for PHP extensions.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MSHUTDOWN()</span></code> is called on PHP extensions <strong>first</strong>, then on Zend extensions <strong>after</strong> (<code class="docutils literal notranslate"><span class="pre">shutdown()</span></code>).</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Like for every hook, there is a precise defined order and you must master it and remember it for complex
use-case extensions.</p>
</div>
<p>In <em>practice</em>, what we can say about it is that :</p>
<ul class="simple">
<li><p>Zend extensions are started <strong>after</strong> PHP extensions. That allows Zend extensions to be sure that every PHP extension
is already loaded when they start. They are then able to replace-and-hook into PHP extensions. For example, if you need
to replace the <code class="docutils literal notranslate"><span class="pre">session_start()</span></code> function handler by yours, it will be easier to do so in a Zend extension. If you do
it in a PHP extension, you must be sure you get loaded after the session extension, and that can be tricky to check and
to master (You still can specify a dependency using a <a class="reference external" href="https://github.com/php/php-src/blob/c18ba686cdf2d937475eb3d5c239e4ef8e733fa6/Zend/zend_modules.h#L118">zend_module_dep</a>).
However, <a class="reference internal" href="extension_skeleton.html"><span class="doc">remember</span></a> that statically compiled extensions are always started before
dynamically compiled ones. Thus, for the session use-case, this is not a problem as <em>ext/session</em> is loaded as static.
Until some distributions (FreeBSD hear us) change that …</p></li>
<li><p>Zend extensions are triggered <strong>before</strong> PHP extensions when a request shows in. That means they got a chance to modify
the engine about the current request to come, so that PHP extensions use that modified context. Opcache uses such a
trick so that it can perform its complex tasks before any extension had a chance to prevent it to.</p></li>
<li><p>Same for request shutdown : Zend extensions can assume every PHP extension has shut down the request.</p></li>
</ul>
</section>
<section id="practice-my-first-example-zend-extension">
<h2>Practice : my first example Zend extension<a class="headerlink" href="#practice-my-first-example-zend-extension" title="Link to this heading">¶</a></h2>
<p>Here we’ll detail in practice some hooks Zend extensions can use, and what to do with them, in some very simple scenario.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Remember that Zend extensions design usually require that you master the
<a class="reference internal" href="../zend_engine.html"><span class="doc">Zend engine</span></a> deeply.</p>
</div>
<p>For our example here, we’re gonna design a Zend extension that uses those hooks :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">fcall_begin_handler</span></code> : We’ll detect what instructions are currently being executed by the VM, and print a message.
The hook catches two things : a call to require/include/eval or a call to any function/method.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">op_array_handler</span></code> : We’ll detect what PHP function is currently being compiled, and print a message.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">message_handler</span></code> : We’ll detect other Zend extensions loaded, and print a message.</p></li>
</ul>
<p>Here is then our skeleton, that we must write ourselves as for Zend extensions, there is no skeleton generator like for
PHP extensions. The files are called <em>pib.c</em> and <em>php_pib.h</em> , the structure of the files stays the same as for PHP
extensions, simply we won’t declare in there the same things:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;php.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Zend/zend_extensions.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;php_pib.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Zend/zend_smart_str.h&quot;</span>

<span class="cm">/* Remember that we must declare such a symbol in a Zend extension. It is used to check</span>
<span class="cm"> * if it was built against the same API as the one PHP runtime uses */</span>
<span class="n">ZEND_DLEXPORT</span><span class="w"> </span><span class="n">zend_extension_version_info</span><span class="w"> </span><span class="n">extension_version_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ZEND_EXTENSION_API_NO</span><span class="p">,</span>
<span class="w"> </span><span class="n">ZEND_EXTENSION_BUILD_ID</span>
<span class="p">};</span>

<span class="n">ZEND_DLEXPORT</span><span class="w"> </span><span class="n">zend_extension</span><span class="w"> </span><span class="n">zend_extension_entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;pib-zend-extension&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;1.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;PHPInternalsBook Authors&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;http://www.phpinternalsbook.com&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;Our Copyright&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w">                               </span><span class="cm">/* startup() : module startup */</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w">                               </span><span class="cm">/* shutdown() : module shutdown */</span>
<span class="w">    </span><span class="n">pib_zend_extension_activate</span><span class="p">,</span><span class="w">        </span><span class="cm">/* activate() : request startup */</span>
<span class="w">    </span><span class="n">pib_zend_extension_deactivate</span><span class="p">,</span><span class="w">      </span><span class="cm">/* deactivate() : request shutdown */</span>
<span class="w">    </span><span class="n">pib_zend_extension_message_handler</span><span class="p">,</span><span class="w"> </span><span class="cm">/* message_handler() */</span>

<span class="w">    </span><span class="n">pib_zend_extension_op_array_handler</span><span class="p">,</span><span class="w">      </span><span class="cm">/* compiler op_array_handler() */</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w">                                     </span><span class="cm">/* VM statement_handler() */</span>
<span class="w">    </span><span class="n">pib_zend_extension_fcall_begin_handler</span><span class="p">,</span><span class="w">   </span><span class="cm">/* VM fcall_begin_handler() */</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w">                                     </span><span class="cm">/* VM fcall_end_handler() */</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w">                                     </span><span class="cm">/* compiler op_array_ctor() */</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w">                                     </span><span class="cm">/* compiler op_array_dtor() */</span>
<span class="w">    </span><span class="n">STANDARD_ZEND_EXTENSION_PROPERTIES</span><span class="w">        </span><span class="cm">/* Structure-ending macro */</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pib_zend_extension_activate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pib_zend_extension_deactivate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pib_zend_extension_message_handler</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pib_zend_extension_op_array_handler</span><span class="p">(</span><span class="n">zend_op_array</span><span class="w"> </span><span class="o">*</span><span class="n">op_array</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pib_zend_extension_fcall_begin_handler</span><span class="p">(</span><span class="n">zend_execute_data</span><span class="w"> </span><span class="o">*</span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
<p>So far so good, this extension compiles as a Zend extension, but does nothing. Not really nothing.
The first lines in the <code class="docutils literal notranslate"><span class="pre">zend_extension</span></code> structure appear in the <code class="docutils literal notranslate"><span class="pre">phpinfo()</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">This</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="n">makes</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Zend</span><span class="w"> </span><span class="n">Scripting</span><span class="w"> </span><span class="n">Language</span><span class="w"> </span><span class="n">Engine</span><span class="o">:</span>
<span class="n">Zend</span><span class="w"> </span><span class="n">Engine</span><span class="w"> </span><span class="n">v3</span><span class="mf">.1.0</span><span class="p">,</span><span class="w"> </span><span class="n">Copyright</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="mi">1998-2017</span><span class="w"> </span><span class="n">Zend</span><span class="w"> </span><span class="n">Technologies</span>
<span class="w">    </span><span class="n">with</span><span class="w"> </span><span class="n">pib</span><span class="o">-</span><span class="n">zend</span><span class="o">-</span><span class="n">extension</span><span class="w"> </span><span class="n">v1</span><span class="mf">.0</span><span class="p">,</span><span class="w"> </span><span class="n">Our</span><span class="w"> </span><span class="n">Copyright</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">PHPInternalsBook</span><span class="w"> </span><span class="n">Authors</span>
</pre></div>
</div>
<p>This is mandatory, the engine reacts like this : it prints the first <code class="docutils literal notranslate"><span class="pre">zend_extension</span></code> fields into engine
information, for every loaded Zend extension.</p>
<p>That’s all for now. Let’s fill-in those empty-body functions now:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pib_zend_extension_message_handler</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ext</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">php_printf</span><span class="p">(</span><span class="s">&quot;We just detected that zend_extension &#39;%s&#39; is trying to load</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">zend_extension</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ext</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Like said before, <code class="docutils literal notranslate"><span class="pre">message_handler()</span></code> is a special hook that Zend extensions may declare to be noticed when another
Zend extension get loaded. But be careful of the order. You must register our “pib” Zend extension first, then
another Zend extension (like opcache) after that, as the <code class="docutils literal notranslate"><span class="pre">message_handler()</span></code> is only called when a Zend extension is
loaded you obviously need to be loaded before to declare it. Chicken and egg.</p>
<p>Then we’ll start to dive into the engine, with our <code class="docutils literal notranslate"><span class="pre">op_array_handler</span></code> hook:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pib_zend_extension_op_array_handler</span><span class="p">(</span><span class="n">zend_op_array</span><span class="w"> </span><span class="o">*</span><span class="n">op_array</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">smart_str</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>

<span class="w">    </span><span class="n">smart_str_appends</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;We just compiled &quot;</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op_array</span><span class="o">-&gt;</span><span class="n">function_name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">num_args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">op_array</span><span class="o">-&gt;</span><span class="n">num_args</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op_array</span><span class="o">-&gt;</span><span class="n">fn_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ZEND_ACC_CLOSURE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">smart_str_appends</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;a closure &quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">smart_str_appends</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;function &quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">smart_str_append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">op_array</span><span class="o">-&gt;</span><span class="n">function_name</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">smart_str_appendc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;(&#39;</span><span class="p">);</span>

<span class="w">        </span><span class="cm">/* The variadic arg is not declared as an arg internally */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op_array</span><span class="o">-&gt;</span><span class="n">fn_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ZEND_ACC_VARIADIC</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">num_args</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">num_args</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">zend_arg_info</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">op_array</span><span class="o">-&gt;</span><span class="n">arg_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">class_name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">smart_str_append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">.</span><span class="n">class_name</span><span class="p">);</span>
<span class="w">                </span><span class="n">smart_str_appendc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39; &#39;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">pass_by_reference</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">smart_str_appendc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;&amp;&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">is_variadic</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">smart_str_appends</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;...&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">smart_str_appendc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;$&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="n">smart_str_append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">num_args</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">smart_str_appends</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">smart_str_appends</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;) in file &quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">smart_str_append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">op_array</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">);</span>
<span class="w">        </span><span class="n">smart_str_appends</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; between line &quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">smart_str_append_unsigned</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">op_array</span><span class="o">-&gt;</span><span class="n">line_start</span><span class="p">);</span>
<span class="w">        </span><span class="n">smart_str_appends</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; and line &quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">smart_str_append_unsigned</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">op_array</span><span class="o">-&gt;</span><span class="n">line_end</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">smart_str_appends</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;the file &quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">smart_str_append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">op_array</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">smart_str_0</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">);</span>
<span class="w">    </span><span class="n">php_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ZSTR_VAL</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">s</span><span class="p">));</span>
<span class="w">    </span><span class="n">smart_str_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Get some information <a class="reference internal" href="../zend_engine.html"><span class="doc">about the Zend Engine</span></a> if you need.</p>
</div>
<p>This hook is triggered by the pass two of the compiler. When the Zend compiler fires in, it compiles a script or a
function. Just before ending, it launches a second compiling pass which goal is to resolve unresolved pointers (which
value couldn’t be known while compiling the script). This is the <code class="docutils literal notranslate"><span class="pre">pass_two()</span></code> function
<a class="reference external" href="https://github.com/php/php-src/blob/81c2a4b9ba0816a0bda4f004aeca634ad8b58970/Zend/zend_opcode.c#L577">which source code</a> you can analyze.</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">pass_two()</span></code> source code, you can see that it triggers the <code class="docutils literal notranslate"><span class="pre">op_array_handler()</span></code> of every registered Zend
extension so far, and it passes it as argument the current not-fully-resolved-yet OPArray. This is what we get as
argument in our function. We then analyze it, and try to pull out some information about it, like the
currently-being-compiled function, its arguments information etc…  Something very close to what the Reflection API
does, we are just a little bit less accurate here, as the OPArray is not fully resolved, we are still part of the
compilation step here. We could have gathered the default argument values f.e (which is not done here), but that would
have added so much complexity to the example that we decided not to show such a part.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Remember that <a class="reference internal" href="../internal_types/strings/smart_str.html"><span class="doc">smart_str are detailed here</span></a>,
<a class="reference internal" href="../zvals.html#zvals"><span class="std std-ref">zvals here</span></a>, <a class="reference internal" href="../zend_engine.html"><span class="doc">OPArrays here</span></a>, etc…</p>
</div>
<p>Let’s continue then ?:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pib_zend_extension_activate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">CG</span><span class="p">(</span><span class="n">compiler_options</span><span class="p">)</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">ZEND_COMPILE_EXTENDED_INFO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pib_zend_extension_deactivate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">CG</span><span class="p">(</span><span class="n">compiler_options</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">ZEND_COMPILE_EXTENDED_INFO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pib_zend_extension_fcall_begin_handler</span><span class="p">(</span><span class="n">zend_execute_data</span><span class="w"> </span><span class="o">*</span><span class="n">execute_data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">execute_data</span><span class="o">-&gt;</span><span class="n">call</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* Fetch the next OPline. We use pointer arithmetic for that */</span>
<span class="w">        </span><span class="n">zend_op</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">execute_data</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">op_array</span><span class="p">.</span><span class="n">opcodes</span><span class="p">[(</span><span class="n">execute_data</span><span class="o">-&gt;</span><span class="n">opline</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">execute_data</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">op_array</span><span class="p">.</span><span class="n">opcodes</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">extended_value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ZEND_EVAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">php_printf</span><span class="p">(</span><span class="s">&quot;Beginning of a code eval() in %s:%u&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ZSTR_VAL</span><span class="p">(</span><span class="n">execute_data</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">op_array</span><span class="p">.</span><span class="n">filename</span><span class="p">),</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">lineno</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="cm">/* The file to be include()ed is stored into the operand 1 of the OPLine */</span>
<span class="w">            </span><span class="n">zend_string</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zval_get_string</span><span class="p">(</span><span class="n">EX_CONSTANT</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">op1</span><span class="p">));</span>
<span class="w">            </span><span class="n">php_printf</span><span class="p">(</span><span class="s">&quot;Beginning of an include of file &#39;%s&#39;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ZSTR_VAL</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
<span class="w">            </span><span class="n">zend_string_release</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">execute_data</span><span class="o">-&gt;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">fn_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ZEND_ACC_STATIC</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">php_printf</span><span class="p">(</span><span class="s">&quot;Beginning of a new static method call : &#39;%s::%s&#39;&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">ZSTR_VAL</span><span class="p">(</span><span class="n">Z_CE</span><span class="p">(</span><span class="n">execute_data</span><span class="o">-&gt;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">This</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
<span class="w">                    </span><span class="n">ZSTR_VAL</span><span class="p">(</span><span class="n">execute_data</span><span class="o">-&gt;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">function_name</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Z_TYPE</span><span class="p">(</span><span class="n">execute_data</span><span class="o">-&gt;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">This</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IS_OBJECT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">php_printf</span><span class="p">(</span><span class="s">&quot;Beginning of a new method call : %s-&gt;%s&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">ZSTR_VAL</span><span class="p">(</span><span class="n">Z_OBJCE</span><span class="p">(</span><span class="n">execute_data</span><span class="o">-&gt;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">This</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
<span class="w">                    </span><span class="n">ZSTR_VAL</span><span class="p">(</span><span class="n">execute_data</span><span class="o">-&gt;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">function_name</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">php_printf</span><span class="p">(</span><span class="s">&quot;Beginning of a new function call : %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ZSTR_VAL</span><span class="p">(</span><span class="n">execute_data</span><span class="o">-&gt;</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">function_name</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">PHPWRITE</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>On request startup, we tell the compiler to generate some extended information into the OPArray it’s going to create.
The flag for that is <code class="docutils literal notranslate"><span class="pre">ZEND_COMPILE_EXTENDED_INFO</span></code>. Extended information are VM OPCode hooks, that is the compiler
will generate a special OPCode before every function is called, and after every function call is finished. Those are
<code class="docutils literal notranslate"><span class="pre">FCALL_BEGIN</span></code> and <code class="docutils literal notranslate"><span class="pre">FCALL_END</span></code> OPCodes.</p>
<p>Here is an example of a simple PHP function call OPCodes, with the ‘foo’ string as first solo argument:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>L9    #1     INIT_FCALL              112                  &quot;foo&quot;
L9    #2     SEND_VAL                &quot;foo&quot;                1
L9    #3     DO_FCALL
L11   #4     RETURN                  1
</pre></div>
</div>
<p>Now the same once we told the compiler to generate additional OPCodes:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>L9    #3     INIT_FCALL              112                  &quot;foo&quot;
L9    #4     EXT_FCALL_BEGIN
L9    #5     SEND_VAL                &quot;foo&quot;                1
L9    #6     DO_FCALL
L9    #7     EXT_FCALL_END
L11   #8     RETURN                  1
</pre></div>
</div>
<p>Like you can see, the OPCodes about sending the argument and calling the function have been surrounded by two
<code class="docutils literal notranslate"><span class="pre">EXT_FCALL_BEGIN</span></code> and <code class="docutils literal notranslate"><span class="pre">EXT_FCALL_END</span></code> OPCodes, those two later will execute <code class="docutils literal notranslate"><span class="pre">fcall_begin()</span></code> and <code class="docutils literal notranslate"><span class="pre">fcall_end()</span></code>
handlers of every declared Zend extensions, like ours.</p>
<p>Remember that a function call, into the engine, is whether a true function call, or the execution of a new included PHP
file, or the execution of a new <code class="docutils literal notranslate"><span class="pre">eval()</span></code> block. Look at the <code class="docutils literal notranslate"><span class="pre">require()</span></code> disassembled:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>L9    #3     EXT_FCALL_BEGIN
L9    #4     INCLUDE_OR_EVAL         &quot;foo.php&quot;
L9    #5     EXT_FCALL_END
L11   #6     RETURN                  1
</pre></div>
</div>
<p>Once those “marker” OPCodes have been generated, when the VM runs the OPArray OPCodes, it will run our <code class="docutils literal notranslate"><span class="pre">fcall_begin()</span></code>
handler we declared. That’s for us a way to detect what function/file/eval is going to be executed just next. We
simply print such information.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Asking the compiler to generate <code class="docutils literal notranslate"><span class="pre">EXT_FCALL</span></code> statements will slow down the executor a lot. About four times
slower to run the exact same code. <code class="docutils literal notranslate"><span class="pre">EXT_FCALL</span></code> should be used for debuggers only, or at least not for
production code as the Zend VM executor is much slower with them activated : this is more code to run for
every fcall/include/eval.</p>
</div>
</section>
<section id="hybrid-extensions">
<h2>Hybrid extensions<a class="headerlink" href="#hybrid-extensions" title="Link to this heading">¶</a></h2>
<p>What we call hybrid extensions, are extensions that are <strong>both</strong> Zend extensions, and PHP extensions.</p>
<p>How is that possible ? And what for ?.</p>
<p>Well there are several answers to such a question :</p>
<ul class="simple">
<li><p>To <a class="reference internal" href="php_functions.html"><span class="doc">register new PHP functions</span></a>, a PHP extension is better than a Zend extension, as it already
knows how to do and has been designed for that specific purpose first. That would be pity not to use it. Opcache
does that.</p></li>
<li><p>If you need to register about all the hooks in the full lifecycle, you’ll obviously need both sides</p></li>
<li><p>If you need to master the order Zend extensions are loaded, f.e to get loaded after opcache, you will need to be
hybrid</p></li>
</ul>
<p>The trick is simple, choose between :</p>
<ul class="simple">
<li><p>You are a PHP extension mainly. You get registered as a PHP extension, and when you start (<code class="docutils literal notranslate"><span class="pre">MINIT()</span></code>), you register
yourself as a Zend Extension (slave).</p></li>
<li><p>You are a Zend extension mainly. You get registered as a Zend extension, and when you start (<code class="docutils literal notranslate"><span class="pre">startup()</span></code>), you
register yourself as a PHP Extension (slave).</p></li>
</ul>
<p>So whether you are a PHP extension master and a Zend extension slave ; Or the opposite flavor.</p>
<p>As for the trick to be fully understood, we repeat here the full lifecycle of PHP and Zend extensions. Picture-print it
into your brain :</p>
<img alt="../../_images/php_extensions_lifecycle_full.png" class="align-center" src="../../_images/php_extensions_lifecycle_full.png" />
<p>Remember however, whatever schema you choose to go with, you’ll have to register the slave part and trigger it by hand,
as the engine obviously won’t do it. The engine triggers automatically the master part.</p>
<section id="hybrid-zend-extension-master-php-extension-slave">
<h3>Hybrid Zend extension master, PHP extension slave<a class="headerlink" href="#hybrid-zend-extension-master-php-extension-slave" title="Link to this heading">¶</a></h3>
<p>Ok that is easy. We don’t want to be loaded as a PHP extension, but exclusively as a Zend extension. To force things,
we won’t publish the mandatory symbol <code class="docutils literal notranslate"><span class="pre">get_module</span></code> that the engine looks for when it tried to register a PHP
extension from reading the INI file.</p>
<p>Thus, we will only be able to be registered as a <em>zend_extension=pib.so</em>. Registering as <em>extension=pib.so</em> will fail,
as the engine will fail to find our not-exported <code class="docutils literal notranslate"><span class="pre">get_module</span></code> symbol.</p>
<p>But, in our startup hook of Zend extension, nothing prevents us from registering ourselves as a PHP extension:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;php.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Zend/zend_extensions.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;php_pib.h&quot;</span>

<span class="cp">#define PRINT(what) fprintf(stderr, what &quot;\n&quot;);</span>

<span class="cm">/* Declared as static, thus private */</span>
<span class="k">static</span><span class="w"> </span><span class="n">zend_module_entry</span><span class="w"> </span><span class="n">pib_module_entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">STANDARD_MODULE_HEADER</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;pib&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Function entries */</span>
<span class="w">    </span><span class="n">PHP_MINIT</span><span class="p">(</span><span class="n">pib</span><span class="p">),</span><span class="w"> </span><span class="cm">/* Module init */</span>
<span class="w">    </span><span class="n">PHP_MSHUTDOWN</span><span class="p">(</span><span class="n">pib</span><span class="p">),</span><span class="w"> </span><span class="cm">/* Module shutdown */</span>
<span class="w">    </span><span class="n">PHP_RINIT</span><span class="p">(</span><span class="n">pib</span><span class="p">),</span><span class="w"> </span><span class="cm">/* Request init */</span>
<span class="w">    </span><span class="n">PHP_RSHUTDOWN</span><span class="p">(</span><span class="n">pib</span><span class="p">),</span><span class="w"> </span><span class="cm">/* Request shutdown */</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Module information */</span>
<span class="w">    </span><span class="s">&quot;0.1&quot;</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Replace with version number for your extension */</span>
<span class="w">    </span><span class="n">STANDARD_MODULE_PROPERTIES</span>
<span class="p">};</span>

<span class="cm">/* This line should stay commented</span>
<span class="cm">ZEND_GET_MODULE(pib)</span>
<span class="cm">*/</span>

<span class="n">ZEND_DLEXPORT</span><span class="w"> </span><span class="n">zend_extension_version_info</span><span class="w"> </span><span class="n">extension_version_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ZEND_EXTENSION_API_NO</span><span class="p">,</span>
<span class="w">    </span><span class="n">ZEND_EXTENSION_BUILD_ID</span>
<span class="p">};</span>

<span class="n">ZEND_DLEXPORT</span><span class="w"> </span><span class="n">zend_extension</span><span class="w"> </span><span class="n">zend_extension_entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;pib-zend-extension&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;1.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;PHPInternalsBook Authors&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;http://www.phpinternalsbook.com&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;Our Copyright&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">pib_zend_extension_startup</span><span class="p">,</span>
<span class="w">    </span><span class="n">pib_zend_extension_shutdown</span><span class="p">,</span>
<span class="w">    </span><span class="n">pib_zend_extension_activate</span><span class="p">,</span>
<span class="w">    </span><span class="n">pib_zend_extension_deactivate</span><span class="p">,</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span>

<span class="w">    </span><span class="n">STANDARD_ZEND_EXTENSION_PROPERTIES</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pib_zend_extension_activate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PRINT</span><span class="p">(</span><span class="s">&quot;Zend extension new request starting up&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pib_zend_extension_deactivate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PRINT</span><span class="p">(</span><span class="s">&quot;Zend extension current request is shutting down&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">pib_zend_extension_startup</span><span class="p">(</span><span class="n">zend_extension</span><span class="w"> </span><span class="o">*</span><span class="n">ext</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PRINT</span><span class="p">(</span><span class="s">&quot;Zend extension is starting up&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* When the Zend extension part will startup(), make it register</span>
<span class="cm">       a PHP extension by calling ourselves zend_startup_module() */</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">zend_startup_module</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pib_module_entry</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pib_zend_extension_shutdown</span><span class="p">(</span><span class="n">zend_extension</span><span class="w"> </span><span class="o">*</span><span class="n">ext</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PRINT</span><span class="p">(</span><span class="s">&quot;Zend extension is shutting down&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">PHP_MINIT_FUNCTION</span><span class="p">(</span><span class="n">pib</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PRINT</span><span class="p">(</span><span class="s">&quot;PHP extension is starting up&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">PHP_MSHUTDOWN_FUNCTION</span><span class="p">(</span><span class="n">pib</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PRINT</span><span class="p">(</span><span class="s">&quot;PHP extension is shutting down&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">PHP_RINIT_FUNCTION</span><span class="p">(</span><span class="n">pib</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PRINT</span><span class="p">(</span><span class="s">&quot;PHP extension new request starting up&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">PHP_RSHUTDOWN_FUNCTION</span><span class="p">(</span><span class="n">pib</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PRINT</span><span class="p">(</span><span class="s">&quot;PHP extension current request is shutting down&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We are done. Starting PHP with such a Zend extension activated will print the following on stderr:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">Zend</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">starting</span><span class="w"> </span><span class="n">up</span>
<span class="n">PHP</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">starting</span><span class="w"> </span><span class="n">up</span>
<span class="n">Zend</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="n">starting</span><span class="w"> </span><span class="n">up</span>
<span class="n">PHP</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="n">starting</span><span class="w"> </span><span class="n">up</span>
<span class="n">PHP</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">shutting</span><span class="w"> </span><span class="n">down</span>
<span class="n">Zend</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">shutting</span><span class="w"> </span><span class="n">down</span>
<span class="n">PHP</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">shutting</span><span class="w"> </span><span class="n">down</span>
<span class="n">Zend</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">shutting</span><span class="w"> </span><span class="n">down</span>
</pre></div>
</div>
<p>Like you can see, the hooks are honored in the right order, except the first two ones. Theoretically, PHP extensions
should startup before Zend extensions, but as we got registered as a Zend extension, when the engine runs our Zend
extension hook, it knows nothing about our PHP extension module startup part (<code class="docutils literal notranslate"><span class="pre">MINIT()</span></code>) yet. We tell it to start our
PHP extension up, and then as part of Zend extension <code class="docutils literal notranslate"><span class="pre">startup()</span></code> hook, we make it trigger the PHP extension startup
hook by hand, by callling for <code class="docutils literal notranslate"><span class="pre">zend_startup_module()</span></code>. Obviously you’ll have to take care not to create a circular
loop and not to make the engine crazy about what you will concretely do in such hooks.</p>
<p>It is perfectly both easy and logical.</p>
<p>From now, we are both a PHP extension and a Zend extension. Look at that:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span><span class="w"> </span><span class="n">php</span><span class="w"> </span><span class="o">-</span><span class="n">dzend_extension</span><span class="o">=</span><span class="n">pib</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="o">-</span><span class="n">m</span>
<span class="p">[</span><span class="n">PHP</span><span class="w"> </span><span class="n">modules</span><span class="p">]</span>
<span class="n">Core</span>
<span class="n">date</span>
<span class="p">(...)</span>
<span class="n">pib</span>
<span class="n">posix</span>
<span class="n">Reflection</span>
<span class="p">(...)</span>

<span class="p">[</span><span class="n">Zend</span><span class="w"> </span><span class="n">Modules</span><span class="p">]</span>
<span class="n">pib</span><span class="o">-</span><span class="n">zend</span><span class="o">-</span><span class="n">extension</span>
</pre></div>
</div>
<p>Our PHP extension is effectively called “pib” and shows up, and our Zend extension is effectively called
“pib-zend-extension” and shows up as well. We chose two different names for both parts, we could have chosen the same
name.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Opcache and Xdebug use such an hybrid model, they are Zend extensions, but they need to publish PHP
functions and thus they are also PHP extensions to do so.</p>
</div>
</section>
<section id="hybrid-php-extension-master-zend-extension-slave">
<h3>Hybrid PHP extension master, Zend extension slave<a class="headerlink" href="#hybrid-php-extension-master-zend-extension-slave" title="Link to this heading">¶</a></h3>
<p>Now let’s go for the other way around : we want to be registered by the engine as a PHP extension, and not as a
Zend extension, but still want to be hybrid.</p>
<p>Well, we’ll do the opposite : we won’t publish our <code class="docutils literal notranslate"><span class="pre">zend_extension_version_info</span></code> symbol, this way it will be
impossible to load us as a Zend extension : the engine will deny that. But obviously this time, we’ll declare a
<code class="docutils literal notranslate"><span class="pre">get_module</span></code> symbol to be able to get loaded as a PHP extension. And, in our <code class="docutils literal notranslate"><span class="pre">MINIT()</span></code>, we’ll register ourselves as
a Zend extension</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;php.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Zend/zend_extensions.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;php_pib.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Zend/zend_smart_str.h&quot;</span>

<span class="cp">#define PRINT(what) fprintf(stderr, what &quot;\n&quot;);</span>

<span class="n">zend_module_entry</span><span class="w"> </span><span class="n">pib_module_entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">STANDARD_MODULE_HEADER</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;pib&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Function entries */</span>
<span class="w">    </span><span class="n">PHP_MINIT</span><span class="p">(</span><span class="n">pib</span><span class="p">),</span><span class="w"> </span><span class="cm">/* Module init */</span>
<span class="w">    </span><span class="n">PHP_MSHUTDOWN</span><span class="p">(</span><span class="n">pib</span><span class="p">),</span><span class="w"> </span><span class="cm">/* Module shutdown */</span>
<span class="w">    </span><span class="n">PHP_RINIT</span><span class="p">(</span><span class="n">pib</span><span class="p">),</span><span class="w"> </span><span class="cm">/* Request init */</span>
<span class="w">    </span><span class="n">PHP_RSHUTDOWN</span><span class="p">(</span><span class="n">pib</span><span class="p">),</span><span class="w"> </span><span class="cm">/* Request shutdown */</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Module information */</span>
<span class="w">    </span><span class="s">&quot;0.1&quot;</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Replace with version number for your extension */</span>
<span class="w">    </span><span class="n">STANDARD_MODULE_PROPERTIES</span>
<span class="p">};</span>

<span class="n">ZEND_GET_MODULE</span><span class="p">(</span><span class="n">pib</span><span class="p">)</span>

<span class="cm">/* Should be kept commented</span>
<span class="cm"> * zend_extension_version_info extension_version_info = {</span>
<span class="cm"> *   ZEND_EXTENSION_API_NO,</span>
<span class="cm"> *    ZEND_EXTENSION_BUILD_ID</span>
<span class="cm"> * };</span>
<span class="cm"> */</span>

<span class="k">static</span><span class="w"> </span><span class="n">zend_extension</span><span class="w"> </span><span class="n">zend_extension_entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;pib-zend-extension&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;1.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;PHPInternalsBook Authors&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;http://www.phpinternalsbook.com&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;Our Copyright&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">pib_zend_extension_startup</span><span class="p">,</span>
<span class="w">    </span><span class="n">pib_zend_extension_shutdown</span><span class="p">,</span>
<span class="w">    </span><span class="n">pib_zend_extension_activate</span><span class="p">,</span>
<span class="w">    </span><span class="n">pib_zend_extension_deactivate</span><span class="p">,</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span>

<span class="w">    </span><span class="n">STANDARD_ZEND_EXTENSION_PROPERTIES</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pib_zend_extension_activate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PRINT</span><span class="p">(</span><span class="s">&quot;Zend extension new request starting up&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pib_zend_extension_deactivate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PRINT</span><span class="p">(</span><span class="s">&quot;Zend extension current request is shutting down&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">pib_zend_extension_startup</span><span class="p">(</span><span class="n">zend_extension</span><span class="w"> </span><span class="o">*</span><span class="n">ext</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PRINT</span><span class="p">(</span><span class="s">&quot;Zend extension is starting up&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">PHP_MINIT_FUNCTION</span><span class="p">(</span><span class="n">pib</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PRINT</span><span class="p">(</span><span class="s">&quot;PHP extension is starting up&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Register our zend_extension part now */</span>
<span class="w">    </span><span class="n">zend_register_extension</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zend_extension_entry</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">pib_zend_extension_shutdown</span><span class="p">(</span><span class="n">zend_extension</span><span class="w"> </span><span class="o">*</span><span class="n">ext</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PRINT</span><span class="p">(</span><span class="s">&quot;Zend extension is shutting down&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">PHP_MSHUTDOWN_FUNCTION</span><span class="p">(</span><span class="n">pib</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PRINT</span><span class="p">(</span><span class="s">&quot;PHP extension is shutting down&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">PHP_RINIT_FUNCTION</span><span class="p">(</span><span class="n">pib</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PRINT</span><span class="p">(</span><span class="s">&quot;PHP extension new request starting up&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">PHP_RSHUTDOWN_FUNCTION</span><span class="p">(</span><span class="n">pib</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PRINT</span><span class="p">(</span><span class="s">&quot;PHP extension current request is shutting down&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And that crashes badly just at the end (sad !), at <code class="docutils literal notranslate"><span class="pre">pib_zend_extension_shutdown()</span></code>. Firing a debugger, it is easy to
know why.</p>
<p>Here, we are loaded as a PHP extension. Look at the hooks. When hitting <code class="docutils literal notranslate"><span class="pre">MSHUTDOWN()</span></code>, the engine runs our
<code class="docutils literal notranslate"><span class="pre">MSHUTDOWN()</span></code>, but <strong>it unloads us</strong> just after that ! It calls for <code class="docutils literal notranslate"><span class="pre">dlclose()</span></code> on our extension,
<a class="reference external" href="https://github.com/php/php-src/blob/4d6100569b7611ef66086bec96fe8b5046e30ef7/Zend/zend_API.c#L2527">look at the source code</a>, the solution is as often located in there.</p>
<p>So what happens is easy, just after triggering our <code class="docutils literal notranslate"><span class="pre">RSHUTDOWN()</span></code>, the engine unloads our <em>pib.so</em> ; when it comes to
call our Zend extension part <code class="docutils literal notranslate"><span class="pre">shutdown()</span></code>, we are not part of the process address space anymore, thus we badly crash
the entire PHP process.</p>
<p>What is the solution ? Well if you read the source, and if you read the other chapters of this book, you should know
that if we pass an env <code class="docutils literal notranslate"><span class="pre">ZEND_DONT_UNLOAD_MODULES</span></code> and put it to 1 , the engine won’t unload us. We could then write
such an env in <code class="docutils literal notranslate"><span class="pre">MSHUTDOWN()</span></code>, and unwrite it in <code class="docutils literal notranslate"><span class="pre">shutdown()</span></code>.
<a class="reference external" href="http://man7.org/linux/man-pages/man3/putenv.3.html">putenv()</a> will do the job. That’s fine even if that’s tricky.
Also, if another extension between us plays with that, that will smell for us.</p>
<p>The second solution is provided by a trick with the unloading mechanism. If you transfer the libdl handle from the PHP
extension structure to the Zend one, you’ll be alright with the engine unloading.</p>
<p>Code patched:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">PHP_MINIT_FUNCTION</span><span class="p">(</span><span class="n">pib</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Dl_info</span><span class="w"> </span><span class="n">infos</span><span class="p">;</span>

<span class="w">    </span><span class="n">PRINT</span><span class="p">(</span><span class="s">&quot;PHP extension is starting up&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Register our zend_extension part, and give it our own PHP extension handle */</span>
<span class="w">    </span><span class="n">zend_register_extension</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zend_extension_entry</span><span class="p">,</span><span class="w"> </span><span class="n">pib_module_entry</span><span class="p">.</span><span class="n">handle</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Prevent the engine from unloading our PHP extension */</span>
<span class="w">    </span><span class="n">pib_module_entry</span><span class="p">.</span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you launch it now, you’ll get the expected result:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PHP</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">starting</span><span class="w"> </span><span class="n">up</span>
<span class="n">Zend</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">starting</span><span class="w"> </span><span class="n">up</span>
<span class="n">Zend</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="n">starting</span><span class="w"> </span><span class="n">up</span>
<span class="n">PHP</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="n">starting</span><span class="w"> </span><span class="n">up</span>
<span class="n">PHP</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">shutting</span><span class="w"> </span><span class="n">down</span>
<span class="n">Zend</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">shutting</span><span class="w"> </span><span class="n">down</span>
<span class="n">PHP</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">shutting</span><span class="w"> </span><span class="n">down</span>
<span class="n">Zend</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">shutting</span><span class="w"> </span><span class="n">down</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Blackfire uses such an hybrid model but hasn’t got a Zend extension shutdown() hook and thus doesn’t need the
patch about module unload.</p>
</div>
</section>
<section id="hybrid-hybrid">
<h3>Hybrid hybrid<a class="headerlink" href="#hybrid-hybrid" title="Link to this heading">¶</a></h3>
<p>Hybrid hybrid is simply a model where you allow the user to load you whether as Zend extension or PHP extension.</p>
<p>What you have to do, is remember how you’ve been loaded, using a global for example, so that you can take care of both
modes.</p>
<p>Let’s write just the diff parts:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">started</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">pib_zend_extension_startup</span><span class="p">(</span><span class="n">zend_extension</span><span class="w"> </span><span class="o">*</span><span class="n">ext</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">started</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">started</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">zend_startup_module</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pib_module_entry</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">PRINT</span><span class="p">(</span><span class="s">&quot;Zend extension is starting up&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">PHP_MINIT_FUNCTION</span><span class="p">(</span><span class="n">pib</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">started</span><span class="p">)</span><span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">started</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">Dl_info</span><span class="w"> </span><span class="n">infos</span><span class="p">;</span>
<span class="w">        </span><span class="n">zend_register_extension</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zend_extension_entry</span><span class="p">,</span><span class="w"> </span><span class="n">pib_module_entry</span><span class="p">.</span><span class="n">handle</span><span class="p">);</span>

<span class="w">        </span><span class="n">dladdr</span><span class="p">(</span><span class="n">ZEND_MODULE_STARTUP_N</span><span class="p">(</span><span class="n">pib</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">infos</span><span class="p">);</span>
<span class="w">        </span><span class="n">dlopen</span><span class="p">(</span><span class="n">infos</span><span class="p">.</span><span class="n">dli_fname</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">PRINT</span><span class="p">(</span><span class="s">&quot;PHP extension is starting up&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Obviously every symbol must be public. With the code above, you can get loaded as PHP extension (extension=pib.so) or
as Zend extension (zend_extension=pib.so) ; end-user will have choice, that’s the advantage of such a model, even if
we authors are not aware of its usage.</p>
</section>
</section>
</section>


      </div>
      <div class="bottomnav" role="navigation" aria-label="Bottom">
      
        <p>
        «&#160;&#160;<a href="ini_settings.html">Declaring and using INI settings</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="../memory_management.html">Memory management</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer feedback">
        The repository for this book is available on <a href="https://github.com/phpinternalsbook/PHP-Internals-Book">GitHub</a>.
        <br/><br/>
        <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
            <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" />
        </a>
        <br />
        The PHP internals book is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
    </div>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-41617167-1', 'phpinternalsbook.com');
      ga('send', 'pageview');
    </script>

  </body>
</html>