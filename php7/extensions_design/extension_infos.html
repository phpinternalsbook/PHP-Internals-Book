<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Publishing extension information &#8212; PHP Internals Book</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/haiku.css?v=fce32b03" />
    <link rel="stylesheet" type="text/css" href="../../_static/style.css?v=38da9290" />
    <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Hooks provided by PHP" href="hooks.html" />
    <link rel="prev" title="Managing global state" href="globals_management.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../index.html">
          <span>PHP Internals Book</span></a></h1>
        <h2 class="heading"><span>Publishing extension information</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="Top">
      
        <p>
        «&#160;&#160;<a href="globals_management.html">Managing global state</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="hooks.html">Hooks provided by PHP</a>&#160;&#160;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <section id="publishing-extension-information">
<h1>Publishing extension information<a class="headerlink" href="#publishing-extension-information" title="Link to this heading">¶</a></h1>
<p>Extensions can publish information asked by <code class="docutils literal notranslate"><span class="pre">phpinfo()</span></code> or the Reflection API. Let’s see that together.</p>
<p>This chapter won’t be too long as there is really no difficulty.</p>
<section id="minfo-hook">
<h2>MINFO() hook<a class="headerlink" href="#minfo-hook" title="Link to this heading">¶</a></h2>
<p>Everything takes place in the <code class="docutils literal notranslate"><span class="pre">MINFO()</span></code> hook you declared, if you declared one.  If you declared none, then the engine
will run a default function to print information about your extension. That function will only print the version of
your extension and the <a class="reference internal" href="ini_settings.html"><span class="doc">INI entries</span></a> you eventually declared. If you want to hook into such
process, you must declare an <code class="docutils literal notranslate"><span class="pre">MINFO()</span></code> <a class="reference internal" href="php_lifecycle.html"><span class="doc">hook</span></a> in your extension structure.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Everything takes place in <a class="reference external" href="https://github.com/php/php-src/blob/ce64b82ebb2ac87e53cb85c312eafc8c5c37b112/ext/standard/info.c">ext/standard/info.c</a> , you may read that file. Printing
information about PHP extensions is done by the engine by calling <a class="reference external" href="https://github.com/php/php-src/blob/ce64b82ebb2ac87e53cb85c312eafc8c5c37b112/ext/standard/info.c#L139">php_info_print_module()</a></p>
</div>
<p>Here is a simple <code class="docutils literal notranslate"><span class="pre">MINFO()</span></code> example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;php/main/SAPI.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ext/standard/info.h&quot;</span>

<span class="cp">#define PIB_TXT  &quot;PHPInternalsBook Authors&quot;</span>
<span class="cp">#define PIB_HTML &quot;&lt;h3&gt;&quot; PIB_TXT &quot;&lt;/h3&gt;&quot;</span>

<span class="n">PHP_MINFO_FUNCTION</span><span class="p">(</span><span class="n">pib</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">time_t</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">cur_time</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

<span class="w">    </span><span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
<span class="w">    </span><span class="n">php_asctime_r</span><span class="p">(</span><span class="n">localtime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">),</span><span class="w"> </span><span class="n">cur_time</span><span class="p">);</span>

<span class="w">    </span><span class="n">php_info_print_table_start</span><span class="p">();</span>
<span class="w">        </span><span class="n">php_info_print_table_colspan_header</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;PHPInternalsBook&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">php_info_print_table_row</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Current time&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cur_time</span><span class="p">);</span>
<span class="w">    </span><span class="n">php_info_print_table_end</span><span class="p">();</span>

<span class="w">    </span><span class="n">php_info_print_box_start</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sapi_module</span><span class="p">.</span><span class="n">phpinfo_as_text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">php_write</span><span class="p">(</span><span class="n">PIB_HTML</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">PIB_HTML</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">php_write</span><span class="p">(</span><span class="n">PIB_TXT</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">PIB_TXT</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="n">php_info_print_box_end</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">zend_module_entry</span><span class="w"> </span><span class="n">pib_module_entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">STANDARD_MODULE_HEADER</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;pib&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Function entries */</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Module init */</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Module shutdown */</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Request init */</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Request shutdown */</span>
<span class="w">    </span><span class="n">PHP_MINFO</span><span class="p">(</span><span class="n">pib</span><span class="p">),</span><span class="w"> </span><span class="cm">/* Module information */</span>
<span class="w">    </span><span class="s">&quot;0.1&quot;</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Replace with version number for your extension */</span>
<span class="w">    </span><span class="n">STANDARD_MODULE_PROPERTIES</span>
<span class="p">};</span>
</pre></div>
</div>
<img alt="../../_images/php_minfo.png" class="align-center" src="../../_images/php_minfo.png" />
<p>What you basically have to do is to deal with <code class="docutils literal notranslate"><span class="pre">php_info_print_*()</span></code> API, that allows to print into the output stream
that is generated. If you want to print some raw information, a simple <code class="docutils literal notranslate"><span class="pre">php_write()</span></code> is enough. <code class="docutils literal notranslate"><span class="pre">php_write()</span></code> just
writes what you pass as argument onto the SAPI output stream, whereas <code class="docutils literal notranslate"><span class="pre">php_info_print_*()</span></code> API does as well, but
before formats the content using HTML <em>table-tr-td</em> tags if the output is expected to be HTML, or simple spaces if not.</p>
<p>Like you can see, you need to include <em>ext/standard/info.h</em> to access the <code class="docutils literal notranslate"><span class="pre">php_info_print_*()</span></code> API, and you will need
<em>php/main/SAPI.h</em> to access the <code class="docutils literal notranslate"><span class="pre">sapi_module</span></code> symbol. That symbol is global, it represents the current <em>SAPI</em> used by
the PHP process. The <code class="docutils literal notranslate"><span class="pre">phpinfo_as_text</span></code> field inform if you are going to write in a “Web” SAPI like <em>php-fpm</em> f.e, or
in a “text” one, like <em>php-cli</em>.</p>
<p>What will trigger your <code class="docutils literal notranslate"><span class="pre">MINFO()</span></code> hook are :</p>
<ul class="simple">
<li><p>Calls to userland <code class="docutils literal notranslate"><span class="pre">phpinfo()</span></code> function</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">php</span> <span class="pre">-i</span></code>, <code class="docutils literal notranslate"><span class="pre">php-cgi</span> <span class="pre">-i</span></code>, <code class="docutils literal notranslate"><span class="pre">php-fpm</span> <span class="pre">-i</span></code>. More generally <code class="docutils literal notranslate"><span class="pre">&lt;SAPI_binary&gt;</span> <span class="pre">-</span> <span class="pre">i</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">php</span> <span class="pre">--ri</span></code> or userland <code class="docutils literal notranslate"><span class="pre">ReflectionExtension::info()</span></code></p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Take care of the output formatting. Probe for <code class="docutils literal notranslate"><span class="pre">sapi_module.phpinfo_as_text</span></code> if you need to change between
text and HTML formatting. You don’t know how your extensions’ infos will be called by userland.</p>
</div>
<p>If you need to display your INI settings, just call for the <code class="docutils literal notranslate"><span class="pre">DISPLAY_INI_ENTRIES()</span></code> macro into your <code class="docutils literal notranslate"><span class="pre">MINFO()</span></code>. This
macro resolves to <a class="reference external" href="https://github.com/php/php-src/blob/4903f044d3a65de5b1c457d9eb618c9e247f7086/main/php_ini.c#L167">display_ini_entries()</a>.</p>
</section>
<section id="a-note-about-the-reflection-api">
<h2>A note about the Reflection API<a class="headerlink" href="#a-note-about-the-reflection-api" title="Link to this heading">¶</a></h2>
<p>The Reflection heavily uses your <code class="docutils literal notranslate"><span class="pre">zend_module_entry</span></code> structure. For example, when you call
<code class="docutils literal notranslate"><span class="pre">ReflectionExtension::getVersion()</span></code>, the API just reads the version field of your <code class="docutils literal notranslate"><span class="pre">zend_module_entry</span></code> structure.</p>
<p>Same to discover functions, your <code class="docutils literal notranslate"><span class="pre">zend_module_entry</span></code> has got a <code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">_zend_function_entry</span> <span class="pre">*functions</span></code> member
which is used to register PHP functions.</p>
<p>Basically, the PHP userland Reflection API just reads your <code class="docutils literal notranslate"><span class="pre">zend_module_entry</span></code> structure and publishes those
information. It may also use your <code class="docutils literal notranslate"><span class="pre">module_number</span></code> to gather back information your extension registered at different
locations against the engine. For example, <code class="docutils literal notranslate"><span class="pre">ReflectionExtension::getINIentries()</span></code> or
<code class="docutils literal notranslate"><span class="pre">ReflectionExtension::getClasses()</span></code> use this.</p>
</section>
</section>


      </div>
      <div class="bottomnav" role="navigation" aria-label="Bottom">
      
        <p>
        «&#160;&#160;<a href="globals_management.html">Managing global state</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="hooks.html">Hooks provided by PHP</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer feedback">
        The repository for this book is available on <a href="https://github.com/phpinternalsbook/PHP-Internals-Book">GitHub</a>.
        <br/><br/>
        <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
            <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" />
        </a>
        <br />
        The PHP internals book is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
    </div>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-41617167-1', 'phpinternalsbook.com');
      ga('send', 'pageview');
    </script>

  </body>
</html>